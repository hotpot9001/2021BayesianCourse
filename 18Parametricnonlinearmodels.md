# 参数非线性模型
---------------
王长鑫 2019302130050
## 一、基础知识
### 1.1 形式

在广义线性模型中，y的期望值是线性预测器的非线性函数：$E(y|X,\beta)=g^{-1}(X\beta)$。广义线性建模是灵活且强大的，系数$\beta$相对容易解释，特别是在相互比较时（因为它们都作用于同一个线性预测器上）。然而，并不是所有的现象都是线性的，即使是在变换的情况下。本章考虑了参数和预测器不是线性组合的更一般的情况。简单的例子包括$E(y)=\frac{a_{1}+b_{1}x_{1}}{a_{2}+b_{2}x_{2}}$，或者两个非线性函数求和，例如$E(y)=A_{1}e^{-a_{1}x}+A_{2}e^{-a_{2}x}$。

### 1.2 步骤

推理和计算的一般原理都可以直接应用于非线性模型。考虑贝叶斯数据分析的三个步骤：模型构建、模型计算和模型检查。最灵活的非线性建模方法通常涉及预测器和结果之间的复杂关系，但通常不需要用到不常用的概率分布。由于我们不能简单地采用线性回归进行计算，模型计算会比较困难。模型检查有时可以使用残差图，卡方检验和其他现有的方法，有时也需要在特定模型中创建一些新的图表。

### 1.3 困难

在解释不能简单地用线性预测器来理解的参数方面存在着一定的困难。任何非线性模型推理的关键步骤是以图形方式来显示拟合非线性关系。因为非线性模型有很多种形式，所以没有系统统一的形式来呈现。通常，每个新的建模问题都必须重新分析解决。

下面是两个有关参数非线性模型的应用示例，给出了具体的分析思路与步骤供大家参考。

## 二. 示例1：连续稀释实验

### 2.1 实验背景知识

估计生物样品中化合物浓度的一种常见设计是连续稀释试验，在该试验中，测量样品的几种不同稀释度。连续稀释每个样品是因为可以通过颜色变化的自动光学读数来测量试验中样品的浓度，但是颜色变化体现的浓度范围的信息有限：在浓度较低时，颜色变化难以察觉，无法体现浓度信息；在浓度较高时，颜色饱和，也无法体现浓度信息。

<div align=center>
<img src="https://github.com/wangchangxinserena/2021BayesianCourse/blob/main/figure/%E5%9B%BE%E7%89%8719-2.1.png" width="80%">
</div>
<p align="center"><strong>图2.1</strong></p>

因此，稀释度给出了几种不同精度的测量值，似然或贝叶斯方法也允许我们适当地结合这些测量中的信息。一个试验是在一个有许多孔的板上，每个孔包含一个样品或一个样品的特定稀释。这里有两种样品：未知样品，是待测量的样品及其稀释度；标准样品，是已知稀释度的化合物，用于校准测量。图2.1展示了一个用于连续稀释试验的96孔的典型板；前两列是已知浓度的“标准”稀释剂，包含标准样品及其稀释度，后10列是未知样品的稀释度数值，主要用作校准，估计未知物质的浓度。未知样品的稀释度比标准样品的稀释度的间隔更宽，以便用给定数量的测定方法覆盖更广的浓度范围。

### 2.2 实验数据

图2.2显示了哮喘患者家中蟑螂过敏原研究的单一板的连续稀释试验数据。大图显示标准数据，十个小图显示未知化合物的数据。每个图显示了单个化合物的光学测量y、稀释度（dilution）以及描述二者关系的估计曲线。下面描述与测量值有关的稀释曲线的估计。

<div align=center>
<img src="https://github.com/wangchangxinserena/2021BayesianCourse/blob/main/figure/%E5%9B%BE%E7%89%8719-2.2.png" width="80%">
</div>
<p align="center"><strong>图2.2</strong></p>

<div align=center>
<img src="https://github.com/wangchangxinserena/2021BayesianCourse/blob/main/figure/%E5%9B%BE%E7%89%8719-2.3.png" width="80%">
</div>
<p align="center"><strong>图2.3</strong></p>

图2.3用稀释试验的标准软件分析光学测量y的示例。标准数据被用来估计校准曲线，然后估计未知样品的浓度。用星号表示样品浓度低于检测下限。需要注意的是，在这些低浓度的观察中，信息仍旧是存在的（这可以通过观察每个样品稀释度从1到1/3到1/9的测量值递减模式知道），只是无法被检测出来。

图2.3体现了目前采用标准方法估计未知浓度的困难。图1.3的左侧显示了标准数据（对应于图2.2中的第一个图）：两个初始样品已知浓度为0.64，每个样品都经过几次稀释以及一次零测量。对于浓度为0.64的样品，光学颜色测量y的值开始于100 以上，并且对于零浓度（所有惰性化合物）样品，光学颜色测量y下降到14左右。图2.3的右侧显示了对于平板上10个未知样品中的2个样品的光学颜色测量y和基于标准方法测得的相应浓度估计值。

对未知样品8的所有估计都用星号表示，表示它们的浓度均低于检测下限，分析这些数据的标准计算机程序没有给出任何估计结果。未知样品9显示了更好的结果，其8个测量值中有4个高于检测下限，4个稀释度较高的测得的测量值低于检测下限。

如图2.2所示，未知样品8和9并不是极端情况，而是该板块数据的某种典型情况。在过敏原的测量中，即使是低浓度也很重要，我们需要能够区分零浓度和仅仅是低浓度这两种情况。这里描述的贝叶斯推理使区分这两者比以前分析这类数据的方法要精确得多。

### 2.3 模型
#### 2.3.1 符号标注
图2.1-2.3所示的研究中感兴趣的参数是未知样本的浓度；对于图2.1所示的列，我们将其标记为$\theta _{1},\dots,\theta _{10}$，标准样品的浓度用$\theta_{0}$表示。我们将浓度$i$标为$x_{i}$，用$y_{i}$表示相应的光学颜色强度测量，根据板中的孔令$i=1,\dots,96$。每个$x_{i}$都是一个样本的特定稀释倍数。我们分阶段建立颜色强度观测的模型:给定浓度下的预期颜色强度的参数模型、光学读数的测量误差、稀释制备过程中引入的误差以及所有参数的先验分布。
#### 2.3.2 给定浓度的预期测量曲线
我们按照这一领域的通常做法，对给定浓度$x$的期望光学读数拟合出以下四参数非线性模型:
$$
E(y|x,\beta)=g(x,\beta)=\beta _{1} +\frac{\beta _{2}}{1+(x/\beta _{3})^{-\beta _{4}}}\tag{2.1}
$$
其中$\beta_{1}$是零浓度下的颜色强度，$\beta_{2}$是达到饱和状态的增加量，$\beta_{3}$是曲线梯度转变时的浓度，$\beta_{4}$是饱和发生的速率，所有参数都限制为非负值。这个模型等价于一个$\log_{}{x}$的缩放和移位的logistic函数。模型与数据吻合得相当好，如上图2.2所示。

#### 2.3.3 测量误差
测量误差建模为方差不等的正态分布:
$$
y_{i} \sim N(g(x_{i},\beta),(\frac{g(x_{i},\beta)}{A})^{2\alpha}\sigma _{y}^{2}),\tag{2.2}
$$
其中参数$\alpha$被限制在0和1之间，对较大测量值的方差更大的形式进行建模。模型(2.2)中的A是任意的，将它设置为值30，位于数据范围的中间。模型中包含了这一参数，使得$\sigma_{y}$作为“典型”测量的误差标准偏差有了更直接的解释。

当α = 0时，模型(2.2)简化为等方差正态模型；当α = 1时，模型近似对应对数尺度上的等方差模型。获得正确的方差关系很重要，因为我们的许多数据都是低浓度的，我们虽然不希望我们的模型使用这些测量，但也不希望夸大它们的精度。

#### 2.3.4 稀释误差
稀释过程在两个地方会产生误差：一是初始稀释，即已测量的标准样品的与已测量的惰性液体混合；二是连续稀释，即样品按固定的因子如2或3稀释。对于蟑螂过敏原数据，连续稀释误差较低，因此我们在模型中只考虑初始稀释误差。

我们使用(自然)对数尺度上的正态模型来计算与制备标准样品相关的初始稀释误差。已知的标准溶液浓度是$\theta _{0}$，$d_{0}^{init}$是(已知)要求的初始稀释标准。如果没有稀释误差，则初始稀释浓度应为$d_{0}^{init}\theta _{0}$。令$x_{0}^{init}$为初始稀释的实际(未知)浓度，那么
$$
\log_{}{(x_{0}^{init})} \sim N(\log_{}{(x_{0}^{init},\theta_{0})},(\sigma ^{init})^{2})\tag{1.3}
$$
对于未知样品j的初始浓度为$x_{j}^{init} =\theta_{j}$，其中$j=1,\dots,10$，对于标准样品和未知样品的进一步稀释，我们简单的设置
$$
x_{i}=d_{i}\cdot x_{j(i)}^{init},\tag{1.4}
$$
其中$j(i)$为观测i对应的样品$(0,\dots,10)$，并且$d_{i}$是观测i相对于初始稀释值的稀释值。2.4中的关系反映了连续稀释误差低到可以忽略的假设。
#### 2.3.5 先验分布
我们认为校准曲线的参数服从无信息先验均匀分布：$\log_{}{\beta_{k}}\sim U(-\infty,\infty)$，其中$k=1,\dots,4$；$\sigma _{y}\sim  U(0,\infty )$；$\alpha\sim U(0,1)$。如图2.1所示的试验带有大量允许我们准确估计所有这些参数的标准数据。我们还为未知样品浓度指定了无信息先验分布：$p(\log_{}{\theta _{j}})\propto 1$，对于每个$j=1,\dots,10$的未知样品。另一项形式如下，$\log_{}{\theta _{j} } \sim N(\mu _{\theta },\sigma _{\theta }^{2}  )$（或者，更好的是一个混合模型，其中包括某些真实浓度$\theta_{j}$为零的可能性），但为了简单起见，我们在该分析中使用no-pooling模型(对应于$\sigma _{\theta } =\infty $)。

模型中有一个参数——$\sigma ^{init} $，初始稀释误差的规模——不能从单个板上估计出来。在我们的分析中，我们将其固定在0.02(即初始稀释误差，标准偏差为2%)，这是以前对不同标准初始稀释度的板的数据进行分析得到的。

#### 2.3.6 推断
使用Bugs包拟合模型，在拟合模型时，可以使用合理的起始点(可以通过从数据中粗略估计得到)并根据参数$\beta_{j}$和未知浓度$\theta_{j}$的对数参数化。校正曲线参数的后验中值估计(和后验50%区间)为$\hat{\beta}_{1}=14.7[14.5,14.9]，\hat{\beta}_{2}=99.7[96.8,102.9]，\hat{\beta}_{3}=0.054[0.051,0.058]，\hat{\beta}_{4}=1.34[1.30,1.38]$。$\beta$的后验中位数估计定义了一条曲线$g(x,\beta )$，如图2.2的左上图所示。正如预期的那样，曲线通过用于估计它的数据。方差参数$\sigma_{y}$和$\alpha$分别估计为2.2和0.97。测量的高精度(从图2.2的重复数据可以看出)允许从相对较小的数据集准确地估计参数。

<div align=center>
<img src="https://github.com/wangchangxinserena/2021BayesianCourse/blob/main/figure/%E5%9B%BE%E7%89%8719-2.4.png" width="80%">
</div>
<p align="center"><strong>图2.4</strong></p>

<div align=center>
<img src="https://github.com/wangchangxinserena/2021BayesianCourse/blob/main/figure/%E5%9B%BE%E7%89%8719-2.5.png" width="80%">
</div>
<p align="center"><strong>图2.5</strong></p>

图2.4显示了对10个未知样本浓度的推断。我们使用这些估计以及估计的校准曲线，绘制了图2.2中显示的10个未知数的比例曲线。图2.5显示了残差，根据图可知残差较为合理。

图2.4 显示了在图2.2中的10个未知数浓度的后验中值、50%区间和95%区间。对所有样本都进行了估计，其中未知样品8的数据均低于检测下限(见图2.3)。

图2.5 是标准化残差与期望值图，对于符合标准的模型和来自单一板块的未知数据。图中的圆圈和叉分别表示来自标准的和未知的测量值，模型拟合没有问题。
#### 2.3.7 与现有估计的比较
该方法是该领域的标准做法，首先估计校准曲线，然后通过反转拟合的校准曲线，将每个测量值从未知样品直接转换为估计浓度。对于每个未知的样品，估计浓度除以它们的稀释度，然后平均得到一个估计。

**贝叶斯分析的估计与标准方法的估计大体相似，但精度更高**。贝叶斯方法的一个优点是，它可以对所有未知进行浓度估计，甚至未知样品8也不例外，因为样品8的所有测量值都低于检测下限。我们还根据每个数据的一半创建了对应的未知浓度估计。对于标准和贝叶斯方法，这两种估计是相似的，但贝叶斯估计的可靠性(即两种估计之间的一致性)要强得多。我们不希望基于单个板的数据做处过于强烈的声明，实际中我们进行了更深入的研究，在一系列实验条件下比较新旧两个方法。

## 三. 示例2：群体毒代动力学
在本节中，我们将讨论一种更为复杂的非线性模型，该模型用于毒代动力学(毒素在体内的流动和代谢研究)，最终目的是评估与特定空气污染物相关的一般人群的风险。**这个模型是分层的和多元的，有一个向量的参数在几个实验对象均被估计。这个模型的先验分布是有信息的和分层的，有独立的方差分量，对应于关于总体平均水平的不确定性和围绕该平均水平的变异。**
<div align=center>
<img src="https://github.com/wangchangxinserena/2021BayesianCourse/blob/main/figure/%E5%9B%BE%E7%89%8719-3.1.png" width="80%">
</div>
<p align="center"><strong>图3.1</strong></p>

图3.1 估计代谢PERC的比例，作为吸入空气中稳态浓度的函数，从估计的年轻成年白人男性总体中随机选择10个假设个体。

### 3.1 背景
全氯乙烯(PERC)是导致动物癌症的许多工业产品之一，其对人类也是如此。PERC一旦被吸入，它将在肝脏中代谢，产生致癌代谢物。因此，在校正PERC的影响时，要研究的相关剂量是肝脏中代谢的量，并不是一个人吸入的所有PERC都会被代谢。在这里，我们重点估计代谢比例作为吸入的空气中化合物浓度的函数以及这个函数如何在人群中变化。为了对我们的推断目标有一个概念，我们先来展示我们分析的一些输出。图3.1显示了吸入PERC的估计比例，作为空气中化合物浓度的函数，这是从估计的年轻成年白人男性总体中随机抽取的10个样本。在描述了统计建模之后，曲线的形状将在下面讨论。使用简单的程序，例如直接测量代谢物浓度(即使在高接触时也很难，在低接触时也不可行)或从动物结果中推断，都是不可能合理地估计这类曲线的。取而代之的是一个毒素通过血液和身体器官流动的数学模型以及毒素在肝脏中的代谢模型，用来估计PERC代谢比例。我们用来拟合毒素流动模型的实验数据样本如图3.2所示。每6个志愿者被暴露在PERC在高层次水平上四个小时(相信足够长时间，使他们身体大多数器官中的PERC浓度达到平衡)，然后测量一段时间内的一个星期(168小时)中呼出空气中PERC的浓度和血液中的PERC浓度。此外，每个人的数据在第二次暴露水平下重复。
<div align=center>
<img src="https://github.com/wangchangxinserena/2021BayesianCourse/blob/main/figure/%E5%9B%BE%E7%89%8719-3.2.png" width="80%">
</div>
<p align="center"><strong>图3.2</strong></p>
图3.2 六名实验对象中每名实验对象进行两次重复，随时间推移，呼出空气和血液中PERC的浓度(毫克/升)，测量值以对数刻度显示。

### 3.2 毒代动力学模型
我们的分析基于一个标准的生理模型，根据这个模型，毒素通过呼吸进入和离开身体，通过血流分布到四个房室——灌注良好的组织、灌注不良的组织、脂肪和肝脏——并在肝脏中代谢。这个模型在毒理学建模方面有很长的历史，并且已经被证明可以重现这些数据的大部分特征。一个简单的单室或双室模型可能更容易估计，但这样的模型与我们的数据的拟合很差，更重要的是，没有精确拟合不同暴露条件的复杂性。我们简要地描述了毒代动力学模型的性质，省略了理解我们的分析所不需要的细节。给定空气中化合物的已知浓度，每个房室中化合物的浓度随时间的变化由一个一阶微分方程控制，其参数为每个房室的体积、血流和分配系数(相对于血液的平衡浓度)。发生代谢的肝腔室的方程与其他腔室稍有不同，它由上述参数和一些附加参数控制。这四个微分方程为每个个体提供共15个参数。我们用符号$\theta _{k} =(\theta _{k1},\dots ,\theta_{kL})$表示，向量L=15与个题k相关的参数。

给定生理参数和初始暴露条件的值，可以使用专门的数值算法求解微分方程，以获得化合物在每个房室的浓度和代谢率作为时间的函数。我们可以将基于微分方程的数值解对呼出空气和血液中PERC浓度的预测与我们观测到的浓度测量相结合，来估计每个个体的模型参数。
### 3.3 估计的困难和先验信息的作用
在毒理学和药理学中估计模型的一个典型困难是，它们预测浓度随时间变化的模式接近指数衰减函数的混合，不同成分的振幅和衰减时间与模型参数的函数相对应。众所周知，估计混合指数的衰减时间是一个病态问题，也就是说，这种模型中的参数很难同时估计。

通过使用生理药代动力学模型有助于解决从间接数据估计代谢的问题，也就是说，个体和群体参数有直接的物理解释(例如，通过脂肪组织的血液流动，或组织/血液分配系数)。这些模型允许通过先前生理数据来识别它们的许多参数值。由于这些模型的参数基本上不可能仅从数据来估计，因此关键是它们具有物理意义，并可以预先分配信息分布。
### 3.4 测量模型
我们首先描述如何使用毒理学模型作为血液和空气浓度测量的非线性模型的组成部分。接下来是对总体模型的描述，该模型允许我们推断与PERC代谢相关的总体特征分布。这些数据是对研究中六个人中每个人呼出的空气和血液浓度的一系列测量。我们把这些数据写作$y_{jkmt}$，其中j表示重复(在我们的数据中，两个暴露水平的j = 1,2)、k表示个体、m表示测量值(m = 1代表血液浓度，m = 2代表空气浓度)，t表示时间。呼出空气和血液浓度的期望值是非线性函数$g_{m}(\theta_{k},E_{j},t)$，其中个体$\theta_{k}$，暴露水平$E_{j}$，时间为t。函数$g_{m}(\cdot )$是我们关于生理参数与期望浓度相关的微分方程组解的简写符号。给定j的输入条件(即$E_{j}$)和参数$\theta_{k}$,其可以数值地评估随时间变化的药物动力学微分方程，并计算出所有测量值的$g_{1}$和$g_{2}$，从而获得所有测量值的期望值。

实际观测到的空气和血液中的浓度也受到测量误差的影响，通常假设这些误差是独立的且对数正态分布的，并且均值为零，标准差为$\sigma_{m}$(对数尺度上)对于m=1，m=2。这些测量误差分布也隐含地解释了模型中的误差。我们允许$\sigma$的两个组成部分有所不同，因为在血液和呼出的空气中的测量有不同的实验技术，因此可能有不同的精度。我们没有特别的理由相信空气和血液测量的建模或测量误差是相关的，因此我们认为$\log_{}{\sigma_{1}} $和$\log_{}{\sigma_{2}} $服从独立的均匀先验分布。(在拟合模型后，我们检查了残差，没有发现任何高度相关性的证据。)

### 3.5 种群模型参数
该项目的目标之一是估计个体药代动力学参数和预测值(如代谢分数(这是个体参数的复杂功能))在一般人群中的分布。在一个实验中有K个个体，我们在K个参数向量上建立了一个层次模型，以便我们可以从总体推断出个体。通常观察到生物参数的偏态、对数正态分布。大多数(如果不是全部的话)生物参数也有生理界限。基于这一信息，经过对数变换和适当的尺度变换后的个体药动学参数被建模为正态分布，总体均值在离均值3个标准差处截断，其中k为个体数，$l= 1,\dots,L$为模型中的药动学参数。对分布进行截断，将模型参数限制在科学合理的值内。此外，当我们从参数的后验分布监测参数模拟时，截断提供了一个有用的作用：如果某参数的模拟卡在截断点附近，表明数据和药动学模型与先验分布有强烈的矛盾，模型的某些部分需要重新检验。

单个个题k的参数向量为$\theta _{k}=(\theta_{k1},\dots,\theta_{kL})$，其中L=15。有些参数是受定义约束的:在讨论的模型中，参数$\theta _{k2}$,$\theta _{k3}$,$\theta _{k4}$,$\theta _{k5}$表示流向每个腔室的血液比例，因此它们的和被限制为1。此外，参数$\theta _{k6}$,$\theta _{k7}$,$\theta _{k8}$与器官体积的比例系数相对应，限制每个个体的总和为0.873(不包括骨骼的瘦体重的标准分数)。在这三个参数中，$\theta _{k8}$(肝脏体积)比其他参数要小得多，而且关于这个量有相当多的先验信息。

为了建模和计算，我们用$\psi _{kl}$定义的一组新的参数对模型进行转换，定义如下:
$$
\begin{align}
&\theta_{kl}=\frac{e^{\psi_{kl} } }{e^{\psi_{k2}  }+e^{\psi_{k3}  }+e^{\psi_{k4}  }+e^{\psi_{k5}  } },for\ l=2,3,4,5\\
&\theta_{kl}=(0.873-e\psi_{k8}  )\frac{e^{\psi _{kl} } }{e^{\psi _{k6} } +e^{\psi _{k7} } },for\ l=6,7 \\
&\theta_{kl}=e^{\psi_{kl} } ,for\ l=1\ and\ 8-15\tag{3.1}
\end{align}
$$
参数$\psi_{k2},\dots,\psi_{k5}$以及$\psi_{k6},\psi_{k7}$是不确定的（例如，向$\psi_{k2},\dots,\psi_{k5}$中添加任意常数都不会改变生理参数$\theta_{k2},\dots,\theta_{k5}$的值），但是它们指定了先验分布，我们可以控制它们的后验分布。

每一组$\psi_{kl}$参数都服从均值为$\mu_{l}$和标准差为$\tau_{l}$的正态分布，在第三个标准差处截断。$\psi$尺度上的建模考虑了$\theta$上的约束，而对无约束分量保留了截断的对数正态分布。所有的计算都是用$\psi$进行的，最后将$\psi$转换回$\theta$，以解释自然尺度上的结果。

在模型中，假设L = 15个生理参数的总体分布是独立的。在拟合模型后，我们检查了6个人的参数对之间的15·14/2相关性，并没有发现它们不为零的证据。如果我们确实发现了较大的相关性，我们要考虑向模型中添加相关性，要么考虑重新参数化以减小相关性。事实上，我们模型中的参数已经进行了转换，以减少相关性。

### 3.6 先验信息
为了拟合种群模型，我们认为L（转化后）生理参数服从均值和方差分别为$\mu_{l}$,$\tau _{l}^{2}$的先验分布。我们给出了每个$\mu_{l}$(参数为$M_{l}$和$S_{l}^{2}$的正态分布)和$\tau _{l}^{2}$(拟卡方分布，以真实总体方差的估计$\tau_{0l}^{2}$为中心，并具有较低的自由度$\nu_{l}$——通常设置为2——表示较大的不确定性)的先验分布。

超参数$M_{l}$、$S_{l}$和$\tau_{0l}$是基于生物学文献中已有的估计。来源包括对人类的研究和动物测量的异速测量。我们为$\mu_{l}$和$\tau_{l}$设置独立的先验分布，因为我们有关参数的先验信息基本上是独立的。在设置不确定性时，我们试图提供弱信息，当生物文献中存在模糊性时，我们将先验方差设置得更高而不是更低。

在毒代动力学实验中，该模型对六个人各有15个参数；$\theta_{jk}$是第j个人的第k个参数值，$j = 1,\dots, 6, k = 1,\dots,15$。有关参数的先验信息可在生物学文献中找到。对于每个参数，区分以下两种差异来源是很重要的：关于参数值的先验不确定性和总体变异。每个参数的对数正态模型表示为$\log_{}{\theta _{jk} } \sim N(\mu _{k},\tau _{k}^{2} )$，总体几何平均$\mu_{k}$和标准差$\tau_{k}$的独立的先验分布分别为$\mu _{k}\sim  N(M_{k},S_{k}^{2}  )$,$\tau _{k}^{2} \sim Inv-\chi ^{2}(\nu ,\tau _{k0}^{2} ) $。$\mu_{k}$的先验分布通常都是通过标准差$S_{k}$体现我们对总体中参数值的不确定性。$\tau_{k}$的先验分布体现了参数的种群变异。由于对种群变异的先验知识并不精确，因此将$\tau_{k}^{2}$的先验分布的自由度设为较小值$\nu=2$。

有些参数比其他参数更容易理解。例如，当肝脏的重量表示为轻体重的一个分数时，估计的总体几何平均值为0.033，总体平均的不确定性和估计的总体异质性均在10%到20%之间。先验参数设置为$M_{k}=log(0.033),S_{k}=log(1.1),\tau_{k0}=log(1.1)$。相比之下，Michaelis-Menten系数(药代动力学模型中的一个特殊参数)就较难理解：其总体几何平均值估计为0.7，但其不确定性可能高达100倍上下。然而，尽管这个参数的大小有很大的不确定性，但人们认为，在人群中的个体之间，它相对于总体均值的变化不超过4个因子。因此先验参数设置为$M_{k}=log(0.7),S_{k}=log(10),\tau_{k0}=log(2)$。层次模型提供了一个基本的框架来表达两种变化(或不确定性)的来源并将它们结合在分析中。

### 3.7 层次模型联合后验分布
对于贝叶斯推断，给定数据和先验信息，通过对层次模型中的所有因素（数据分布:$p(y|\psi ,E,t,\sigma )$，总体模型:$p(\psi|\mu,\tau)$，先验分布:$p(\mu,\tau|M,S,\tau_{0})$）求乘积，我们会得到所有参数的后验分布。
$$
\begin{align}
p&(\psi,\mu,\tau^{2},\sigma^{2}|y,E,t,\phi,M,S,\tau_{0}^{2},\nu)\\
&\propto p(y|\psi,\phi,E,t,\sigma^{2})p(\psi|\mu,\tau^{2})p(\mu,\tau^{2}|M,S,\tau_{0}^{2})p(\sigma^{2})\\
&\propto
(\prod_{j=1}^{J} \prod_{k=1}^{K} \prod_{m=1}^{2} \prod_{t}^{}N(\log_{}{y_{jkmt}}|\log_{}{g}_{m} (\theta_{k},E_{j},t),\sigma_{m}^{2} ))\sigma_{1}^{-2}\sigma_{2}^{-2}\times\\
&\times
(\prod_{k=1}^{K}\prod_{l=1}^{L} N_{trunc} (\psi_{kl}|\mu_{l},\tau_{l}^{2})) (\prod_{l=1}^{L}N(\mu_{l}|M_{l},S_{l}^{2})Inv-\chi ^{2}(\tau_{l}^{2}|\nu_{l},\tau_{0l}^{2} ) ),\tag{3.2}
\end{align}
$$
其中$\psi$是一组个体水平的参数向量，$\mu$和$\tau$分别是总体均值和标准差的向量，$\sigma$是测量方差，y是浓度测量的向量，E和t是暴露浓度和时间，M，S，$\tau$和$\nu$是超参数。我们使用$N_{trunc}$作为正态分布在离均值的特定标准差处截断。j，k，l，m以及t表示重复（实验重复），个体，参数，测量类型（血液或空气）以及测量时间。为了计算(3.2)的参数、数据和实验条件的函数，$g_{m}$函数必须在与实验测量相对应的时间范围内进行数值计算。

### 3.8 计算
我们的目标是首先将药动力学模型与实验数据拟合，然后使用该模型进行推断。我们通过从后验分布中随机抽取参数来达到这些目标，$p(\psi,\mu,\tau^{2},\sigma^{2}|y,E,t,\phi,M,S,\tau_{0}^{2},\nu)$。我们采用Gibbs抽样方法，按如下顺序迭代更新参数：$\sigma,\tau,\mu,\psi_{1},\dots,\psi_{K}$，这些每一个都是一个矢量参数。$\sigma^{2},\tau^{2}$和$\mu$分量的条件分布分别是逆卡方分布、逆卡方分布和正态分布。$\psi$参数的条件分布没有封闭解，因此我们使用Metropolis算法的步骤进行抽样，该算法只需要计算后验密度到一个乘常数的能力，如(3.2)。

Metropolis算法的实现一次改变一个人的参数(因此，在每个迭代中有K个跳跃，每个跳跃影响一个L维向量$\psi_{k}$)。参数向量使用以当前值为中心的正态分布，协方差矩阵与从一些初始运行中获得的一个成比例，并缩放，以便接受率大约为0.23。每次更新一个人的参数意味着Metropolis步骤中需要计算的后验密度的唯一因素是那些与该人相对应的因素。这个问题非常重要，因为评估函数$g_{m}$以获得测量的期望值是计算中耗费最大的部分。另一种方法是每次改变一个组分$\psi_{kl}$;这需要在每次迭代中进行KL跳转。

我们执行5次独立的模拟运行，每一次迭代5万次，起始点是通过从其先验分布中随机采样$\psi_{kl}$，然后设置总体平均$\mu_{l}$为其先验均值$M_{l}$来获得的。然后我们通过绘制$\sigma$和$\tau$开始模拟。由于存储空间的限制，我们只保存参数向量每10次迭代一次。我们通过比较模拟内部和模拟之间的方差来监控模拟的收敛。

### 3.9 对感兴趣量的推论
首先，我们检查了关于模型参数及其种群变异性的推论，并检查了这些推论是否有意义，是否与先验分布一致。在此之后，主要感兴趣的量是在不同暴露场景下代谢的PERC的比例，这是通过在适当的输入条件下数值评估微分方程模型计算出来的。对于每个个体k，我们可以计算每个模拟参数向量$\psi_{k}$的代谢分数；使用这组模拟结果可以得到个体代谢分数的分布。每个个体分布的方差是由于生理参数$\psi_{k}$的后验分布的不确定性造成的。
<div align=center>
<img src="https://github.com/wangchangxinserena/2021BayesianCourse/blob/main/figure/%E5%9B%BE%E7%89%8719-3.3.png" width="80%">
</div>
<p align="center"><strong>图3.3</strong></p>
图3.3显示了实验中每个人在高暴露水平为百万分之50 (ppm)和低暴露水平为百万分之0.001 (ppm)时代谢的PERC分数的后验分布。这六个人实际上并没有接触到这些水平；推论是通过运行微分方程模型与这两个假设的输入条件以及每个人的估计参数。我们选择这两个层次来说明来自模型的推论：高水平对应职业性暴露，低水平对应环境暴露。我们可以也确实考虑过其他的暴露场景。图中显示了六个人代谢部分的高剂量和低剂量估计值之间的相关性，个体之间存在很大的差异。

通过模拟生理参数来自总体分布的随机向量，对人群中另外一个人(即与研究对象交换的人)进行了类似的模拟。所得的PERC代谢分数的总体分布方差包括参数估计中的后验不确定性和群体中真实的个体间变异。代谢分数的区间估计可以作为模拟分布的百分位数来获得。在高暴露(50 ppm)下，人群中代谢部分的95%区间为[0.5%，4.1%]；在低暴露量(0.001 ppm)下为[15%，58%]。

我们还研究了一天内(经过三周的吸入暴露后)PERC代谢的比例作为暴露水平的函数。这就是我们在介绍PERC例子时所展示的关系;如图2.1所示。在低暴露下，由于新陈代谢是线性的，因此代谢的部分保持不变。饱和开始出现在1ppm处并大约在10ppm时完成。在较高水平下，由于单位时间内的代谢量达到最大值，因此代谢分数随暴露量呈线性下降。

在解释这些结果时，人们必须记住，它们是基于一个单独的实验。这项研究似乎是目前最好的研究之一；然而，它只包括来自同质人群的6人，仅在两种暴露条件下测量。与结果相关的许多不确定性是由于这些实验的局限性。通过收集和分析这些人的额外数据，可以减少研究对象参数的后验不确定性。为了更多地了解种群，我们需要更多的个体。在本研究中，种群变异性大约与后验不确定性一样大，如果纳入一组异质性更强的受试者，可能会增加。

### 3.10 评估模型的拟合性
除了它们在给定模型的推断中所起的作用外，后验模拟还可以用几种方法来检验模型的拟合性。
最直接的是，我们可以基于$\theta$的后验分布模型，通过比较观测数据$y_{jkmt}$来检验测量和建模$g_{m}(\theta_{k},E_{j},t)$的误差。
<div align=center>
<img src="https://github.com/wangchangxinserena/2021BayesianCourse/blob/main/figure/%E5%9B%BE%E7%89%8719-3.4.png" width="80%">
</div>
<p align="center"><strong>图3.4</strong></p>
图3.4显示了我们所有观测数据(即观测数据除以模型的预测)与模型预测的相对预测误差的散点图。(由于分析是贝叶斯的，我们有许多参数向量的模拟绘制，每一个都产生略有不同的预测数据。图3.4为简单起见，仅显示了从这些随机选择的模拟图中的一个预测。)与此类数据的其他拟合相比，这些误差的大小是相当低的。
<div align=center>
<img src="https://github.com/wangchangxinserena/2021BayesianCourse/blob/main/figure/%E5%9B%BE%E7%89%8719-3.5.png" width="80%">
</div>
<p align="center"><strong>图3.5</strong></p>
我们还可以通过将其预测与原始拟合中未使用的额外数据进行比较来检验模型。我们使用了对人类志愿者进行的第二次吸入实验的结果，在实验中，6名志愿者暴露在0.5 - 9ppm(远低于我们研究中的浓度)和呼出空气中的浓度的PERC恒定水平下在长达50分钟的暴露时间里(时间要短得多)测量了血液。由于这些是新的个体，我们使用种群分布$p(\theta|\mu,\tau)$作为非线性模型的参数，创建了血液/呼出空气浓度比的后验模拟。图3.5给出了观测数据和模型预测(模拟边界为95%和99%)。尽管暴露水平比我们数据中使用的低5到100倍，但模型总体上吻合得很好。然而，该模型没有很好地描述短期动力学(接触后不到15分钟)，它只包括对肺交换的简单描述。

### 3.11 使用具有信息先验分布的复杂模型
我们的分析有五个关键特征，都不可或缺:

(1)一个生理模型

(2)一个种群模型

(3)关于种群生理参数的先验信息

(4)实验数据

(5)贝叶斯推断

如果缺少这五个特性中的任何一个，模型将无法工作:

(1)没有一个生理模型，就没有很好的方法来获得关于参数的先验信息。

(2)没有一个种群模型，通常没有足够的数据来估计每个个体的模型。

(3和4)多室生理模型的参数不能仅靠数据或先验信息来准确确定。

(5)贝叶斯推断得到的参数分布与先验信息和数据一致，如果这种一致性是可能的。因为它自动包括推断不确定性和总体变异性，层次贝叶斯方法产生的后验分布可以直接用于风险评估过程的不确定性分析。

## 四. 参考文献
1.Andrew Gelman,John B. Carlin,Hal S. Stern,David B. Dunson,Aki Vehtari,Donald B. Rubin.Bayesian Data Analysis, Third Edition[M].Chapman and Hall/CRC,2013

2.Carroll, R. J., Ruppert, D., and Stefanski, L. A. (1995). Measurement Error in Nonlinear Models.New York: Chapman & Hall.

3.Giltinan, D., and Davidian, M. (1995). Nonlinear Models for Repeated Measurement Data. London:Chapman & Hall.

4.Reilly, C., and Zeringue, A. (2004). Improved predictions of lynx trappings using a biological model.In Applied Bayesian Modeling and Causal Inference from Incomplete-DataPerspectives, ed. A.Gelman and X. L. Meng, 297–308. New York: Wiley.

5.Fisher, R. A. (1922). On the mathematical foundations of theoretical statistics. Philosophical Transactions of the Royal Society 222, 309–368.

6.McCullagh, P., and Nelder, J. A. (1989). Generalized Linear Models, second edition. New York:
Chapman & Hall.

7.Racine-Poon, A., Weihs, C., and Smith, A. F. M. (1991). Estimation of relative potency with sequential dilution errors in radioimmunoassay. Biometrics 47, 1235–1246.

8.Higgins, K. M., Davidian, M., Chew, G., and Burge, H. (1998). The effect of serial dilution error
on calibration inference in immunoassay. Biometrics 54, 19–32.

9.Gelman, A., Chew, G. L., and Shnaidman, M. (2004). Bayesian analysis of serial dilution assays.Biometrics 60, 407–417.

10.Gelman, A., Bois, F. Y., and Jiang, J. (1996). Physiological pharmacokinetic analysis using population modeling and informative prior distributions. Journal of the American Statistical Association 91, 1400–1412.

11.Zhao, L. H. (2000). Bayesian aspects of some nonparametric problems. Annals of Statistics 28,532–552.

12.Neal, R. M. (1996a). Bayesian Learning for Neural Networks. New York: Springer.

13.Denison, D. G. T., Holmes, C. C., Mallick, B. K., and Smith, A. F. M. (2002). Bayesian Methods
for Nonlinear Classification and Regression. New York: Wiley.
