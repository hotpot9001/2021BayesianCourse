<center>第21章</center>

#                                                                高斯过程模型

-------------------------------------------------

​	*周瑾纯-2019302130047*



​	在第20章中，我们考虑了像样条和核回归这样的基函数方法，这些方法通常需要选择一组任意的结点。我们可以预先指定一个网格中有许多结点，然后通过选择和收缩变量来有效地减少那些不必要的结点，但即使这样仍然可能有一些结点对初始网格存在敏感性。高维网格会导致沉重的计算负担，而低维网格可能不够灵活。另一种更具独特的计算和理论优势的可能方法是使用高斯过程为回归函数建立一个先验分布。高斯过程是一类灵活的模型，其中任何有限维边际分布都是高斯分布，它可以看作是高斯分布的无限维泛化。

## 21.1 高斯过程回归

​	高斯过程的实现依赖于随机函数，因此高斯过程具有多变量预测器与相互作用，无需明确指定基函数的特性使得它作为未知回归函数 $\mu(x)$ 的先验分布而言是合乎情理的。我们将一个高斯过程写为 ${\mu\sim GP(m, k)}$ ，用均值函数$m$和协方差函数$k$参数化。$\mu$之前的高斯过程将其定义为随机函数（随机过程），其中任意$n$个预先指定点的值$x_1$，从$n$维正态分布中可得：
$$
\mu(x_1),...,\mu(x_n)\sim N((m(x_1),...,m(x_n)),K(x_1,...,x_n)),
$$
​	上式平均值为$m$，协方差为$K$。高斯过程 $\mu\sim GP(m，k)$ 是一个非参数模型，因为在所有可能的预测值$x$下，有无穷多个参数表征回归函数 $\mu(x)\in \chi$。均值函数表示对回归函数的初始猜测，线性模型 $m(X)=X\beta$ 代表了某种简单的特殊情况，即该均值函数中的回归系数$\beta$被动选择了一个超先验。将高斯过程集中在线性模型上，同时允许该过程适应与线性模型的偏差就能解决维数灾难问题。因为后验过程可以在数据支持的范围内向线性模型（或替代参数平均函数）靠近。线性基模型在跨稀疏数据区域插值时也很有用。

​	函数$k$指定过程在任意两点之间的协方差，$K$是一个$n×n$维的协方差矩阵，其中元素$(p,q)$对应于$k(x_p，x_q)$，简写为$k(x，x^′)$。协方差函数控制高斯过程实现的平滑度和向平均值收缩的程度，其常选用平方指数（或指数化二次或高斯）作为协方差函数：
$$
k(x,x^′)=\tau^2exp(-\frac{|x-x^′|^2}{l^2}),
$$
<img src="https://github.com/karency/2021BayesianCourse/blob/da81895e849606448702c2857862ba42a1906adf/figure/21-1.jpg" align="center">

<center/>图21.1使用平方指数协方差函数、振幅参数τ以和长度尺度参数l的不同值从高斯过程先验随机抽取<center>


​	其中$\tau$和$l$是协方差[^1]中的未知参数，$| x− x^′|$ [^2]是$x$和$x^′$之间的平方欧氏距离。其中$\tau$控制函数的大小，$l$控制函数的平滑度。图$21.1$显示了高斯过程在假设具有不同$\tau$和$l$值的平方指数协方差函数时的实现结果。先验高斯过程在能够拟合广泛的光滑曲面的同时，对于中等数量乃至大量的预测因子也具有计算可处理性，这一点很有吸引力。这与基差扩展有关。特别地，如果选择基于基函数系数的先验高斯过程，则实际可以获得$\mu$的诱导$GP$先验，其均值和协方差函数取决于先验高斯过程中的超参数以及基的选择。为了证明这一点，有：
$$
\mu(x)=\sum_{h=1}^H \beta_hb_h(x),\beta=(\beta_1,...,\beta_H)\sim N(\beta_0,\sum{}{}_\beta),
$$
​	这是一个在系数上具有多元正态先验的基函数模型，接着：
$$
(\mu(x_1,...,\mu(x_n))\sim N_n((m(x_1),...,m(x_n)),k(x_1,...,x_n)),
$$
​	其均值和协方差公式为：
$$
m(x)=b(x)\beta_0,   k(x,x^′=b(x)^T\sum{}{}_\beta b(x^′),
$$
​	以及 $b(x)=(b_1(x),...,b_H(x))$。这种关系也以另一种方式起作用。具有典型协方差函数（如平方指数）的高斯过程在无限基展开方面具有等效表示，并且这种展开的截断可用于加速计算。

### *协方差函数*

​	不同的协方差函数可用于添加结构先验假设，如平滑性、非平稳性、周期性和多尺度或层次结构。高斯过程的和和和积也是高斯过程，它允许不同协方差函数的简单组合。线性模型也可以表示为具有点积协方差函数的高斯过程。虽然将线性模型表示为高斯过程在计算上通常不是最有效的，但它可以很容易地扩展分层广义线性模型，以概括非线性效应和隐式交互作用。当存在多个预测因子且重点是多元回归时，使用单个参数$l$来控制$\mu$在所有方向上的平滑度并不理想。这种各向同性高斯过程在有效描述回归曲面方面表现不佳，其响应平均值在某些预测因子中的变化比其他预测因子更快，而仅使用回归函数中的预测因子子集可能获得同样好的预测性能。在这样的设置中，各向异性高斯过程可能是更好的选择，并且人们可以使用例如修改的平方指数协方差函数：
$$
k(x,x^′)=cov(\mu(x),\mu(x^′))=\tau^2exp(-\sum_{j=1}^p\frac{|x_j-x_j^′|^2}{l_j^2}),
$$
​	其中，$l_j$是控制第$j$个预测器方向平滑度的长度刻度参数。可以通过为这些参数设定优先级来进行非参数变量的选择，以使数据自适应于真正的各向异性平滑度水平，从而使不需要的预测值在相应$l_j$较大时被剔除。

### *推论*

​	给出一个高斯观测模型，$y_i\sim N(\mu_i, σ^2),i = 1,..., n$，先验高斯过程在给定$\tau$， $l$，$ σ$时是有条件共轭的，因此，给定$(x_i, y_i)^n _{i=1}$时$\mu$的条件后验仍然是一个高斯过程，但具有更新的均值和协方差。在实践中，一个人不能估计无限多种情况下的$µ$，因此重点是$x = (x_1，...， x_n)$和任何属于预测感兴趣的属于$x$的其他位置。给定高斯过程先验$GP(0, k)$，在属于$x$的附加位置上，观测到的$y$和$\mu$的联合密度只是一个多元高斯分布：
$$
\begin{pmatrix}
y\\
\tilde{\mu}\\
\end{pmatrix} \sim N (\begin{pmatrix}
0\\
0\\
\end{pmatrix} ,\begin{pmatrix}
K(x,x)+\sigma^2I&K(\tilde{x},x)\\
K(x,\tilde{x})&K(\tilde{x},\tilde{x})\\
\end{pmatrix})
$$
​	将噪声方差$σ^2$加到协方差的对角上，得到$y$的协方差。隶属于$\tau$、$l$、$\sigma$和数据的条件后验来自于多元高斯的性质(回想一下3.5节中已知方差的多元正态模型的表示)。零先验表示$\tilde{\mu}$的后验在不属于原始数据集$x$的新值$\tilde{x}$处的后验为：
$$
\tilde{\mu}|x,y,\tau,l,\sigma \sim N(E(\tilde{\mu}),cov(\tilde{\mu}))\\
E(\tilde{\mu})=K(\tilde{x},x)(K(x,x)+\sigma^2I)^{-1}y\\
cov(\tilde{\mu})=K(\tilde{x},\tilde{x})-K(\tilde{x},x)(K(x,x)+\sigma^2I)^{-1}K(x,\tilde{x}).
$$
​	图21.2给出了图$\tilde{\mu}^s$属于高斯过程的后验分布，假设高斯过程先验与图21.1相同，且$\sigma= 0.1$。似乎后验计算在高斯过程回归中是一件琐碎的事情，主要涉及两个障碍。首先,计算$n$变量下的正常条件后验分布$\tilde{\mu}$的均值和协方差，涉及矩阵求逆,需要利用$O (n^3)$计算。这种计算在每一个超参数变化的$MCMC$步骤都需要重复，因此，随着$n$的增加，计算费用迅速增加。当$n$大于几千、预测器数量大于3或超参数数量大于15左右时，拟合高斯过程回归模型就变得具有挑战性。

### *协方差函数近似*

​	有大量关于高斯过程的近似的文献是通过减少矩阵反演负担来加快计算速度的。一些高斯过程例如:

<img src="https://github.com/karency/2021BayesianCourse/blob/da81895e849606448702c2857862ba42a1906adf/figure/21-2.jpg" align="center">

图21.2拟合了10个数据点的高斯过程$\mu(x)$的后验图，条件是表征过程的参数$\tau$， $l$的三种不同选择。与图21.1相比，图21.1显示了每个模型的先验分布绘制的曲线。在我们通常的分析中，我们将先验分布分配给$\tau$，$ l$，然后对这些参数连同曲线$\mu(x)$进行联合后验推断；见图21.3。我们在这里展示条件后验分布的这三种选择，以说明$τ$， $l$在后验推断中的作用。

​	代表马尔可夫随机场。当有三个或更少的预测因子时，利用条件独立生成稀疏精确矩阵可以有效地计算马尔可夫随机场。在单变量情况下，可以使用顺序推理在时间$O(n)$内进行计算，即使$n$大于百万，计算也没有问题。对于空间问题，可以用特定的算法在$O(n^{\frac 32})$时间内进行计算。当基函数的数量$m$远小于$n$时，在低维情况下也可以用高斯过程与基函数近似。随着维数的增加,基函数的选择数据的空间变得更加困难(见20.3节)。

​	如果潜在函数建模为加性函数，即低维近似值之和，则当预测值的数量较大时，可以使用上述近似值（见第20.3节）。每个加性分量中可以包含2个或3个预测因子的交互作用，但任意预测因子之间具有隐式交互作用的模型不容易计算。

​	如果函数发生快速变化，则依赖项的长度范围相对较短。利用紧支撑协方差函数得到稀疏协方差矩阵从而大大减少了反演所需的时间。即使有几十个预测器，协方差矩阵也可以是稀疏的。

​	如果函数是平滑的，则依赖项的长度比例相对较长。可以通过许多不同的方式获得协方差矩阵的降秩近似，从而将反演所需的时间减少到$O(mn^2)$，其中$m≪ N$。尽管设置降秩近似可能更困难，降秩近似依然可用于高维数据，因此近似误差在任何地方都很小。在加性模型中也可以组合不同的协方差函数近似值，例如，通过组合长短尺度相关性的不同近似值。

### *边际似然与后验概率*

​	如果数据符合高斯过程模型，则可以通过分析$\mu$得到协方差函数参数$\tau$和$l$的对数边际似然和剩余方差$σ^2$：
$$
log p(y|\tau,l,\sigma^2)=-\frac n2log(2\pi)-\frac 12log|K(x,x)+\sigma^2I|-\frac 12y^T(K(x,x)+\sigma^2I)^{-1}y.
$$
​	边际似然与先验结合，得到非标准化的边际后验，推理可采用第10-13章所述的方法进行。图21.3展示了使用与图21相同的数据估算$\tau$、$l$和$\sigma$的边际后验分布，以及$\mu(x)$的后验平均值和使用图21.1中数据的对$\mu(x)$进行逐点90%的波段测量。我们使用切片采样获得后验模拟。$\tau$和$l$的先验值为$t_4^+(0,1)$，$\sigma$的先验值为对数均匀。

<img src="https://github.com/karency/2021BayesianCourse/blob/da81895e849606448702c2857862ba42a1906adf/figure/21-3.jpg" align="center">

图21.3给定与图21.2相同的10个数据点，高斯过程参数$τ$，$l$和误差尺度$σ$的边缘后验分布，以及$\mu(x)$的后验均值和逐点90%波段。

## 21.2 例子:生日和生日日期

​	高斯过程可以直接适用于数据，但更一般地说，它更常作为更大模型中的组件使用。我们用一个包含1969-1988年间美国每天所有出生记录的数据集中的生日频率模式分析来说明。我们最初了解到，这些数据被用来揭示万圣节生孩子少和情人节生孩子多的情况（可能是由于计划分娩的选择，以及出于健康原因是否诱导分娩的决定）。我们认为，一个模型不仅应当关注特殊的日子，而且一周中的某一天的影响以及一年中的模式和长期趋势都是十分有必要关注的，这很有启发性。

### *将时间序列分解为高斯过程之和*

​	基于日历的结构知识，我们从一个加法模型开始：
$$
y_t(t)=f_1(t)+f_2(t)+f_3(t)+f_4(t)+f_5(t)+\epsilon_t,
$$
​	式中，$t$是以天为单位的时间（从1969年1月1日的$t=1$开始），不同的术语表示不同尺度和周期的变化：

1. 由具有平方指数协方差函数的高斯过程建模的长期趋势：

$$
f_1(t) \sim GP(0,k_1),{\,\,\,\,}k_1(t,t^{'})=\sigma_1^2exp(-\frac{|t-t^{'}|^2}{l_1^2});
$$

2. 使用具有不同振幅和尺度的平方指数协方差函数的$GP$的短期变化：

$$
f_2(t) \sim GP(0,k_2),{\,\,\,\,}k_2(t,t^{'})=\sigma_2^2exp(-\frac{|t-t^{'}|^2}{l_2^2});
$$

3. 每周准周期模式（允许随时间变化）建模为周期和平方指数协方差函数的乘积：

$$
f_3(t) \sim GP(0,k_3),{\,\,\,\,}k_3(t,t^{'})=\sigma_3^2exp(-\frac{2sin^2(\pi(t-t^{'})/7}{l_{3,1}^2})exp(-\frac{|t-t^{'}|^2}{l_{3,2}^2});
$$

4. 使用周期和平方指数协方差函数乘积的年度平滑季节模式（周期365.25以匹配一年的平均长度）：

$$
f_4(t) \sim GP(0,k_4),{\,\,\,\,}k_4(s,s^{'})=\sigma_4^2exp(-\frac{2sin^2(\pi(s-s^{'})/365.25}{l_{4,1}^2})exp(-\frac{|s-s^{'}|^2}{l_{4,2}^2}),
$$

​	其中$s=s(t)=t$，周期为365.25。因此，每四年调整一次日历。

5. 特殊的日子，包括与周末的互动。基于最初的目视检查和事先了解，我们选择了以下特殊日子：元旦、情人节、闰日、愚人节、独立日、万圣节、圣诞节以及圣诞节和新年之间的日子。

$$
f_5(t)=I_{special{\,}day}(t)\beta_a+I_{weekend}(t)I_{special{\,}day}(t)\beta_b,
$$

​	其中，$I_{special{\,}day}(t)$是13个指标变量的行向量，对应于每个特殊日（我们可以将此向量视为$n×13$指标矩阵$I_{special{\,}day}$对应的一行）；$I_{weekend}(t)$是一个指示变量，如果$t$是周六或周日，则等于1，否则等于0；$\beta_a$和$\beta_b$向量，每一个长度为13，对应于在工作日或周末的特殊日子的影响。

6. 最后，$\epsilon_t \sim N(0，\sigma^2)$表示非结构化残差。

​    我们为时间尺度参数$l$设置弱信息对数$t$先验（以提高模型的可识别性），并为所有其他超参数设置对数一致先验。我们将每日出生数$y$标准化为平均值0和标准偏差1。

​	高斯过程之和也是高斯过程，其协方差函数为:
$$
k(t,t^{'})=k_1(t,t^{'})+k_2(t,t^{'})+k_3(t,t^{'})+k_4(t,t^{'})+k_5(t,t^{'}).
$$
​	然后，利用基本的高斯过程方程对模型进行简单的推断。

​	我们通过分析确定了超参数的边际似然及其梯度，如（21.1）所示，并对超参数使用了边际后验模式。因为$n$相对较高（对应于二十年期间的所有天数，即$n≈ 20·365.25$），这种模式在实践中效果良好。中央复合设计（$CCD$）集成给出了视觉上无法区分的图形，$MCMC$的速度太慢了。对于这种一维数据，计算时间为$O(n^3)$的高斯过程公式不是最优的，但计算时间仍然是合理的。

​	图21.4显示了缓慢的趋势、较快的非周期相关变化、周趋势及其随年份的变化、季节效应及其随年份的变化以及年中日效应。所有曲线图均采用相同的比例尺，显示相对于基线$100$的差异。不同加性分量的预测可以用通常的后验方程（21.1）计算，但只使用一个协方差函数来计算训练和测试数据之间的协方差。例如，缓慢趋势的平均值计算如下：
$$
E(\tilde{f_1})=K(\tilde{x},x)(K(x,x)+\sigma^2I)^{-1}y
$$
​	平滑的季节效应与九个月前的日照量或平均温度成反比。周末出生人数较少，特殊日子出生人数较少或较多，这可以通过选择性剖腹产和诱导分娩来解释。随着时间的推移，一周中的一天模式变得更加明显，考虑到这类出生率的普遍增长，这是有道理的。

<img src="https://github.com/karency/2021BayesianCourse/blob/da81895e849606448702c2857862ba42a1906adf/figure/21-4-1.jpg" align="center">

<img src="https://github.com/karency/2021BayesianCourse/blob/da81895e849606448702c2857862ba42a1906adf/figure/21-4-2.jpg" align="center">

​	图21.4根据1969年至1988年每天的确切数据，美国的相对出生人数，分为不同的组成部分，每个组成部分都有一个加性高斯过程模型。图21.5显示了改进模型的估计。

### *一种改进的模型*

​	统计模型不是一次性建立的。相反，我们要适应一个模型，用此注意到问题，并改进它。在这种情况下，只选择一些特殊的日子，就不可能发现其他日子有相当大的影响。此外，我们可能会看到一个“铃声”模式，即在特殊日子之前和之后的出生扭曲(因为婴儿必须在某个时候出生)。

​	为了考虑到这些结构，我们构建了一个新的模型，允许一年中的每一天都有特殊效果。在分析第一个模型时，我们也注意到残差有轻微的自相关，所以我们添加了一个非常短的时间尺度的非周期成分来解释这一点。为了改进每年的周期性成分，我们还改进了模型处理闰日。我们改进的模型有这样的形式：
$$
y_t(t)=f_1(t)+f_2(t)+f_3(t)+f_4(t)+f_5(t)+f_6(t)+f_7(t)+f_8(t)+\epsilon_t:
$$

1. 用平方指数协方差函数高斯过程建模的长期趋势：

$$
f_1(t) \sim GP(0,k_1),{\,\,\,\,}k_1(t,t^{'})=\sigma_1^2exp(-\frac{|t-t^{'}|^2}{l_1^2});
$$

2. 使用具有不同振幅和尺度的平方指数协方差函数的GP的短期变化：

$$
f_2(t) \sim GP(0,k_2),{\,\,\,\,}k_2(t,t^{'})=\sigma_2^2exp(-\frac{|t-t^{'}|^2}{l_2^2});
$$

3. 每周准周期模式(允许随时间变化)，建模为周期和平方指数协方差函数的乘积：

$$
f_3(t) \sim GP(0,k_3),{\,\,\,\,}k_3(t,t^{'})=\sigma_3^2exp(-\frac{2sin^2(\pi(t-t^{'})/7}{l_{3,1}^2})exp(-\frac{|t-t^{'}|^2}{l_{3,2}^2});
$$

4. 使用周期和平方指数协方差函数乘积的年度平滑季节模式(周期为365.25以匹配一年的平均长度)：

$$
f_4(t) \sim GP(0,k_4),{\,\,\,\,}k_4(s,s^{'})=\sigma_4^2exp(-\frac{2sin^2(\pi(s-s^{'})/365}{l_{4,1}^2})exp(-\frac{|s-s^{'}|^2}{l_{4,2}^2});
$$

​	$s = s(t)$现在是一个经过修改的时间，在闰日之前和之后的时间都增加了0.5天，所以在$s$中，对于闰年，一年的长度也是365(使年周期的实现更容易)。

5. 使用周期协方差函数的工作日(日-年效应)的年快速变化模式:

$$
f_5(t) \sim GP(0,k_5),{\,\,\,\,}k_5(s,s^{'})=I_{weekday}(t)\sigma_5^2exp(-\frac{2sin^2(\pi(s-s^{'})/365}{l_{5}^2});
$$

6. 周末也有类似的情况：

$$
f_6(t) \sim GP(0,k_6),{\,\,\,\,}k_6(s,s^{'})=I_{weekday}(t)\sigma_6^2exp(-\frac{2sin^2(\pi(s-s^{'})/365}{l_{6}^2});
$$

7. 年复一年日期不固定的特殊日子(闰日、阵亡将士纪念日、劳动节、感恩节)的影响：

$$
f_7(t)=I_{special{\,}day}(t)\beta,
$$

​	其中$I_{special{\,}day}(t)$现在是一个由4个指标变量组成的行向量，对应于这些浮动假期。

8. 使用具有平方指数协方差函数的高斯过程的短期变化：

$$
f_8(t) \sim GP(0,k_8),{\,\,\,\,}k_8(t,t^{'})=\sigma_2^2exp(-\frac{|t-t^{'}|^2}{l_8^2});
$$

9. 最后，$\epsilon_t \sim N(0,\sigma^2)$对非结构化残差进行了建模。

<img src="https://github.com/karency/2021BayesianCourse/blob/da81895e849606448702c2857862ba42a1906adf/figure/21-5-1.jpg" align="center">

<img src="https://github.com/karency/2021BayesianCourse/blob/da81895e849606448702c2857862ba42a1906adf/figure/21-5-2.jpg" align="center">

*图21.5根据1969年至1988年每天的确切数据，将美国的相对出生人数分为不同的组成部分，每个组成部分采用加性高斯过程模型。与图21.4相比，改进后的模型允许一年中的每一天都有单独的效应，而不仅仅是几个选定的日期。*

​	我们为时间尺度参数$l$设置了弱信息$log-t$先验(以提高模型的可识别性)，并为所有其他超参数设置了$log-uniform$先验。出生人数$y$被归一化，均值为0，标准差为1。

​	利用多元高斯函数的特性，可以在与后验预测相似的时间内计算出删去一个交叉验证的逐点预测。交叉验证的逐点预测精度为$lppd_{loo−cv}=2074$（第一个模型）和$2477$（改进模型），显示出明显的进步。

​	图21.5显示了第二个模型的结果。趋势和星期日效应与第一个模型无法区分，但季节性成分更为平滑，因为它不需要在特殊日期之前或之后对出生人数的增加进行建模，也不需要在年末前时间节点进行建模，现在这些模型都是在星期日成分中建模的。这个新模型也不是完美的（一方面，将局部积极和消极影响的平均值限制在大约为零是有意义的，这样额外的婴儿就可以明显地“借用”邻近的日子），但我们相信图21.5所示的分解，它很好地识别了不同时间尺度下的主要模式。诀窍是使用高斯过程来允许模型的不同组成部分具有不同的变化尺度。这个例子还说明了我们如何在不失去对估计的控制的情况下，不断地向加法模型添加项。

## 21.3 潜在高斯过程模型

​	在非高斯似然情况下，高斯过程先验被设为一个潜在函数$f$，通过一个链接函数确定似然$p(y|f,φ)$，与广义线性模型一样(见第16章)。通常情况下，形状参数$φ$被假定为标量，但也可以使用单独的潜在高斯过程来模拟位置$f$和形状参数$φ$的可能性。例如，尺度取决于预测器。

​	潜在f的条件后验密度为$p(f|x,y,\theta,\phi)∝ p(y|f,\phi)p(f|x,\theta)$。为了有效地进行$MCMC$推断，可以使用$GP$特定的采样器。这些采样器利用先验知识的多元高斯形式来计算提案分布或潜在变量标度中的潜在值。最常用的取样器是椭圆切片取样器、缩放$Metropolis Hastings$和缩放$HMC/NUTS（$这些是在第11章和第12章中讨论的取样器的高斯过程特定变化）。通常交替采样潜在值$f$、协方差和似然参数$\theta$和$\phi$。由于潜在值和（超）参数之间的依赖性，$MCMC$的混合可能会很慢，在适应较大的数据集时会产生困难。

​	由于潜在值的先验分布是多元高斯分布，潜在值的后验分布也往往接近高斯分布；这激发了高斯后验近似。最简单的方法是使用法线近似（第4章）：
$$
p(f|x,y,\theta,\phi)\approx N(f|\widehat{f},\sum),
$$
式中，$\widehat{f}$为后模态，且:
$$
{\sum}^{-1}=K(x,x)+W,
$$
其中$K(x，x)$是先验协方差矩阵，$W$是$W_{ii}=\frac{d^2}{df^2}log{\,\,}p(y|f_i,\phi)|_{f_i=\widehat{f}_i}$的对角矩阵。近似预测密度:
$$
p(\widetilde{y}_i|\widetilde{x}_i,x,y,\theta,\phi)\approx \int p(\widetilde{y}_i|\widetilde{f}_i,\phi)N(\widetilde{f}_i|\widetilde{x}_i,x,y,\theta,\phi)d\widetilde{f}_i
$$
可以被计算。例如，使用正交积分。对数边际似然可以通过使用拉普拉斯方法对$f$积分来近似（第13.3节）：
$$
log{\,\,}p(y|x,\theta,\phi)\approx log{\,\,}g(y|x,\theta,\phi)\varpropto log{\,\,}p(y|\widehat{f},\phi)-\frac{1}{2}\widehat{f}^TK(x,x)^{-1}\widehat{f}-\frac{1}{2}log|B|,
$$
当$|B|=|I+W^{\frac{1}{2}}K(x,x)W^{\frac{1}{2}}|$时。

​	如果似然贡献是严重倾斜的，就像逻辑模型一样，可以使用期望传播（第13.8节）。也使用了变分近似（第13.7节），但在许多情况下，它比标准近似慢，并且不如$EP$精确。使用这些潜在后验的解析近似之一，可以解析地计算超参数 $q(\theta,\phi|x,y)$及其梯度的近似（非标准化）边缘后验及其梯度，从而能够有效地找到超参数的后验模式（第13.1节）或者使用$MCMC$（第12节）、网格积分（第10.3节）或$CCD$积分（第13.9节）对超参数进行积分。

### **实例：白血病存活时间**

​	为了用不是高斯过程的数据说明高斯过程模型，我们分析了成人急性髓系白血病（AML）的生存率。这个例子说明了高斯过程建模非线性效应和隐式相互作用的灵活性。

​	就数据而言，我们拿到了英国西北白血病登记处1982年至1998年间记录的1043例患者的存活时间$t$和截尾指标$z$（0表示观察到，1表示截尾）。大约16%的案件被审查。预测因素包括年龄、性别、诊断时的白细胞计数（1个单位=50×109/L）和 $Townsend$评分，该评分是居住区贫困程度的衡量标准。

​	由于白细胞测量值严格为正且高度倾斜，我们将模型与其对数相匹配。理论上当$n→ ∞$时，高斯过程模型可以与估计的链接函数相匹配，以便直接从数据中学习此类映射。但对于有限样本$n$，可以使用合理的变换对数据进行预处理。将连续预测值标准化为零均值和单位标准差。生存时间标准化为时间对数的零平均值（这样常数项将更小，计算更稳定)。

​	我们尝试了几种模型，包括比例风险模型、威布尔模型和对数高斯模型，但对数$logistic$模型给出了最好的结果。对数高斯模型假设生存时间的对数符合高斯分布，与对数高斯模型相比，对数$logistic$模型可以被认为是更稳健的选择。由于我们没有检查过程的模型，我们无法完整的得到模型公式。对数逻辑模型的可能表达式为：
$$
p(y|-)=\prod_{i=1}^n(\frac{ry^{r-1}}{exp(f(X_i))})^{1-z_i}(1+(\frac{y}{exp({f(X_i)})})^r)^{z_i-2},
$$
​	其中$r$是形状参数，$z_i$是截尾指标（关于截尾观测的更多信息，请参见第8.7节）。我们将高斯过程集中在一个线性模型上，得到一个潜在模型：
$$
f_i(X_i)=\alpha+X_i\beta+\mu(X_i),
$$
​	其中$\mu\sim GP(0, k)$具有平方指数协方差函数：
$$
k(x,x')=cov(\mu(x),\mu(x'))=\sigma_g^2exp(-\sum_{j=1}^{p}\frac{|x_j-x'_j|^2}{l_j}).
$$
​	我们设置了弱信息先验：同样在$log{\,\,}r$上，正态先验$\alpha \sim N(0,\sigma_{\alpha}^2)$，$ \beta\sim N(0, \sigma_{\beta}^2)$，在$σ_{\alpha}^2$ ，$ σ^2_{\beta}$ ， $σ^2_{g}$和$l_j \sim Cauchy^+(0,1)$上独立的$Inv-χ^2(1,1)$先验。我们用拉普拉斯方法求潜在值，用$CCD$积分求超参数。期望传播方法产生了类似的结果，但要慢一个数量级。

​	采用线性响应和重要性加权近似，去一交叉验证预测的计算时间是后验推断的3倍。对于只有常数和线性潜在分量的模型，交叉验证的点态预测精度为$lppd_{loo−cv}=−1662$，对于附加非线性分量的模型，交叉验证的点态预测精度为−1629，这是一个明显的改进。图21.6显示了每个预测器与所有其他固定于其平均值或定义值的预测器的估计条件比较。

​	该模型发现了明显的非线性模式，并且右边的底部子图还表明，与$WBC$相关的条件比较与汤森剥夺指数有相互作用。高斯过程模型的好处是，我们不需要为函数明确定义任何参数形式或定义任何交互项。

​	在之前的研究中，$WBC$没有进行对数转换，因为只考虑了加法模型，既没有发现当$WBC$较小时预期寿命的降低，也没有发现$WBC$与$TDI$之间的相互作用，而额外的空间成分解释了一些变化。但将其加入上述模型后，其影响并不显著。

<img src="https://github.com/karency/2021BayesianCourse/blob/da81895e849606448702c2857862ba42a1906adf/figure/21-6.jpg" align="center">

*图21.6 在白血病的例子中，每个预测器与固定于其平均值或定义值的其他预测器的估计条件比较。每个图中的粗线是使用高斯过程模型估计的后验中值，细线表示逐点90%的间隔。*

## 21.4 功能数据分析

​	功能数据分析将对象的响应和预测值视为无限多点定义的随机函数，而不是标量或向量值随机变量。实际上，人们只能在有限多个点上得到对应函数的观测值。让$y_i=(y_{i1},…,y_{ini})$表示关于主体$i$的函数$f_i$的观察值，其中$y_{ij}$是在点$t_{ij}$处的观察值，且$t_{ij}∈ T$。例如，$f_i:T→ ℜ$ 可能对应于血压或体重随年龄变化的轨迹。考虑到平滑轨迹观测中的测量误差，我们有：
$$
y_{ij}\sim N(f_i(t_{ij}),\sigma^2).
$$
​	然后，问题是如何为不同主题的函数集合$\lbrace f_i\rbrace^n_{i=1}$建模，在为单个函数建模时考虑灵活性，同时也允许借用其他信息。

​	高斯过程可以很容易地用于功能数据分析。例如，在正态回归中，我们有：
$$
y_{ij}\sim N(f(x_i,t_{ij}),\sigma^2).
$$
​	其中，$x_i$是受试者特异性预测因子。我们设一个先验的高斯过程$f \sim GP(m, k)$，以及例如，平方指数协方差，通过添加时间作为额外维度：
$$
\tau^2exp(-[\sum_{j=1}^p \frac{(x_j-x'_j)^2}{l_j^2}+\frac{(t-t')^2}{l_{p+1}^2}]),
$$
​	式中，$τ$控制震级，$l_1,...,l_{p+1}$控制不同预测器方向的平滑度。更相似的$x$和$x^′$意味着更相似的$f$和$f^′$。这种数据自然地由高斯过程建模，不需要额外的计算方法。

## 21.5 密度估计回归

​	到目前为止，我们已经讨论了高斯过程作为控制参数观测模型的位置和潜在形状参数的函数的先验分布。为了提高灵活性，我们还将把条件观测模型建模为非参数模型。这样做的一种方法是$Logistic$高斯过程（$LGP$），在后面的章节中，我们考虑基于狄里克雷过程的另一种方法。

### 密度估计

​	在介绍$LGP$之前， 为了简单起见,我们从独立同分布的情况开始，即 $y_i \thicksim^{iid} p$。$LGP$的工作原理是从高斯过程生成一个随机曲面（一维密度情况下的曲线），然后将曲面转换为概率密度空间。为了将函数约束为非负积分为1，我们使用连续逻辑变换，有：

$$
p(y|f)=\frac{e^{f(y)}}{\int e^{f(y^{'})dy'}},
$$
​	其中$f\sim GP(m，k)$是连续高斯过程的一种实现。选择$m$作为诱发参数的对数密度分布是很有优势的，例如学生$-TDI$分布，其中的参数是根据经验或是作为推断的一部分整合出来的。定义过程的平滑特性的协方差函数$k$可以被选择为平方指数，例如：
$$
k(y,y')=\tau^2exp(-\frac{|y-y'|^2}{l^2}),
$$
其中$\tau$控制幅度，而$l$控制实现的平滑度。

​	另一种规范使用$[0,1]$上的零均值高斯过程$W(t)$并定义：
$$
p(y)=g_0 \frac{e^W(G_0(y))}{\int e^{W(v)}dv},
$$
其中，$g_0$是累积分布函数$G_0$的一些导出分布参数。$G_0$的复杂度允许在$[0,1]→ ℜ$时的$GP$模型，并导致$g_0$尾部的先验平滑度更高，这可能是我们追求的一个理想状态。

​	这个推理的难点是在可能的分母上对连续函数$f$进行积分。这个积分通常在实践中是用有限基函数表示或通过所选有限区域的离散化计算出来的。$f$和$m$、$k$的参数可以用各种马尔可夫链模拟方法进行推断，也可以用拉普拉斯法和参数求积法相结合的方法进行推断。与混合模型密度估计(见第22和23章)相比，$logistic$高斯过程具有计算优势，因为$f$的后验分布是单峰且给定了超参数的(总和固定的有限表示)。

<img src="https://github.com/karency/2021BayesianCourse/blob/da81895e849606448702c2857862ba42a1906adf/figure/21-7.jpg" align="center">

*图21.7两个使用高斯过程的密度估计的简单例子。左栏显示酸度数据，右栏显示星系数据。顶部行显示直方图，底部行显示logistic高斯过程密度估计值和90%点态后验间隔。*

​	**实例：一维密度：星系和湖泊**

​	我们用统计文献中的两个小的单变量数据集说明了$logistic$高斯过程密度估计。第一个例子是一组82个从我们自己的星系发散的星系速度的数据。第二个例子是威斯康星州中北部155个湖泊的酸度测量值数据。我们拟合了一个以高斯为中心的$Matren(ν=52)$协方差函数的高斯过程。使用拉普拉斯方法（即模式中心法向近似）对$f$和超参数的边缘后验模式进行积分。通过拒绝采样设计了另一个迫使拖尾减小的先验约束。图21.7显示了通常的直方图和$LGP$密度估计值。与图22.4中使用混合高斯估计的密度相比，$LGP$为密度估计提供了更灵活的形式。

### 密度回归

​	通过在条件密度集合$p_χ= \lbrace{p(y|x), x∈ℜ^p, y∈ℜ\rbrace}$上设置一个先验，可以很容易地将上述$LGP$先验推广到密度回归：
$$
p(y|x)=\frac{e^{f(x,y)}}{\int e^{f(x,y^{'})dy'}},
$$
$f$是从高斯过程中得到的，比如平方指数协方差核：
$$
k((x,y),(x',y'))=\tau^2exp(-[\sum_{j=1}^p\frac{(x_j-x'_j)^2}{l_j}+\frac{(y-y')^2}{l_{p+1}}]).
$$
人们可以为$l_js$选择超先验，允许某些预测因子有效地退出模型，同时允许其他预测因子发生相当大的变化。

​	让$s = (s_1,...,s_p)∈[−1,1]^p, t∈[0,1]$，并预先指定单调连续函数$F_j:ℜ→[−1,1], j = 1,…, p$的一个可选的复杂表示为：
$$
p(y|x)=g_0(y)\frac{e^{W(F(x),G_0(y))}}{\int e^{W(f(x),v)}dv},
$$
其中$F(x) = (F_1(x_1),…, F_p(x_p))$和$W$是由高斯过程得出的。这里复杂化带来了与无条件密度估计相同的优点。

​	密度回归的推断类似于无条件密度估计，尽管如果有多个预测器需要接近$GP$或证明计算多维函数的有限表示计算可行，则会出现额外的挑战。

### 潜变量回归

​	最近，有人提出了一种简单的替代$LGP$的方法，该方法也依赖于高斯过程先验来诱导密度或条件密度的先验，但方式完全不同。再次关注单变量$iid$的情况，考虑潜在变量回归模型(没有预测因素)：
$$
y_i\sim N(\mu(u_i),\sigma^2),{\,}{\,}u_i\sim U(0,1),
$$
​	其中$u_i$是统一的潜变量，$\mu:[0,1]→ℜ$是未知的回归函数。$\sigma$的先验分布引出了$y_i$密度的相应的先验分布$f \sim Π$。有一篇关于类似的非参数潜在变量模型(21.5)的动机在多元数据分析的降维的文献。对于任何严格正密度$f_0$，可以通过绘制均匀随机变量$u_i$来采样$y_i \sim f_0$，然后让设$y_i= F^{−1}_0(ui)$，其中$F^{−1}_0$为与密度$f_0$对应的逆累积分布。$\sigma^2$上有一个先验，它把正概率赋给0的邻域。通过在$\mu$上设置一个灵活的先验，直观地说明了为什么它是灵活的(21.5)。

​	从实际应用的角度来看，一种方便而灵活的选择是从一个$μ_0$为中心的高斯过程中提取$μ$，其中$\mu_0$以平方指数协方差核为中心。为使未知密度的先验集中在一个猜想$g_0$上，可以让$\mu_0≡G^{−1}_0$。当猜测$g_0$提供适当的近似时，这样的定心将有助于实际性能。计算可以通过一个简单的数据增强算法来实现。在潜在变量$u_i$上，表达式(21.5)是一个标准的高斯过程回归模型，计算可以通过标准算法进行，例如，从一个多元高斯条件的唯一$u_i$值上更新$\mu$。通过在细网格上用离散均匀逼近连续的$U(0,1)$，可以：(a)实现网格上$u_i$的共轭更新；(b)减少在已实现的$u_i$值上更新$\mu$的计算负担。

​	潜在变量回归模型(21.5)可以很容易地推广到密度回归问题，只要简单地让：
$$
y_i\sim N(\mu(u_i,x_i),\sigma^2),{\,\,\,}u_i\sim U(0,1),
$$
​	式中$x_i= (x_{i1},…,x_{ip})$是观测到的预测因子的向量。这个模型本质上与(21.5)相同，计算可以以同样的方式进行，但现在$µ:ℜ^{p+1}→ℜ$是一个$(p +1)$维曲面，由高斯过程绘制而不是一维曲线。协方差函数可以被选择为每个维度具有不同空间范围(平滑度)参数的指数平方函数，类似于(21.4)。这对于允许有足够的灵活性自适应地退出不需要的预测器，并允许某些预测器对条件响应密度有显著更大的影响非常重要。

## 参考文献

​	O’hagan (1978)， Neal(1998)和Rasmussen and Williams(2006)是关于高斯过程的贝叶斯推断的关键参考文献。Vanhatalo等人(2013a)综述了高斯过程计算方面的许多最新进展。Rasmussen和Nickish(2010)为Rasmussen和Williams(2006)的书提供了软件，而Vanhatalo等人(2013b)提供了实现各种不同的模型、协方差逼近、推理方法(如拉普拉斯、期望传播和$MCMC$)和高斯过程模型评估工具的软件。

​	最近一些关于高斯过程中有效贝叶斯计算的参考文献是Tokdar (2007)， Banerjee, Dunson，和Tokdar(2011)用于回归，Vanhatalo和Vehtari(2010)用于二元分类，Riihimaki, Jylanki，和Vehtari(2013)用于多类分类，Vanhatalo, Pietilainen，和Vehtari(2010)用于结合长尺度和短尺度近似的疾病制图，Jylanki、Vanhatalo和Vehtari(2011)用于稳健回归，Riihimaki和Vehtari(2010)用于单调回归。Savitsky, Vannucci, and Sha(2011)提出了一种高维高斯过程回归中变量选择的方法。Lindgren, Rue, and Lindstrom(2013)利用相应的随机偏微分方程的近似弱解来近似一些高斯过程与高斯马尔可夫随场下。Sarkka, Solin和Hartikainen(2013)展示了特定类型的时空高斯过程回归如何通过Sarkka(2013)回顾的贝叶斯滤波和平滑方法，转换成有限或无限维状态空间模型，从而允许有效的(线性时间)推断。

​	生日数据来自国家生命统计系统的出生数据，并提供在http://www.mechanicalkern.com/static/birthdates-1968-1988.csv。由Robert Kern使用谷歌BigQuery提供。

​	白血病的例子来自Henderson, Shimakura和Gorst(2002)。Myllymaki, Sarkka和Vehtari(2013)讨论了点模式的功能数据分析中的高斯过程。$logistic$高斯过程($LGP$)由Leonard(1978)提出。Lenk(1991, 2003)基于后验矩进行推理。Tokdar(2007)提出了无条件$LGP$的$MCMC$实现，Tokdar、Zhu和Ghosh(2010)提出了$MCMC$用于$LGP$密度回归。Riihimaki和Vehtari(2013)推导了$LGP$密度估计和回归的快速拉普拉斯近似。Tokdar和 Ghosh(2007)和Tokdar, Zhu,以及 Ghosh(2010)分别证明了$LGP$对于密度估计和密度回归的一致性。Adams等人(2009)提出了一种替代的$GP$方法，该方法通过条件集和精心设计的拒绝抽样方法避免了在似然中标准化项的数值逼近。第21.5节最后一部分的潜变量回归模型来源于Kundu and Dunson(2011)。

## 练习

1. 复制图21.1中的高斯过程的采样。在网格中使用单变量$x$。从多元正态随机样本的生成在附录$a$中描述。发明一些数据，计算(21.1)中的后验均值和协方差，并从后验分布得到样本函数。

2. 高斯过程:$naes04.csv$文件包含了年龄、性别、种族和对2004年全国安纳伯格选举调查中三个同性恋相关问题的态度。这三个问题是:受访者是否支持禁止同性婚姻的宪法修正案，受访者是否支持允许同性婚姻的州法律，以及受访者是否认识任何同性恋者。第499页的图20.5显示了后两个问题的数据(所有性别和种族类别的平均值)。对于这个练习，您只需要考虑结果作为年龄的函数，而为简单起见，您应该使用二项分布的正态近似值来计算每个年龄的Yes回答的比例。

   (a)建立一个高斯过程模型，估计人口中认为自己认识某个同性恋的人的百分比(2004年)，作为年龄的函数。用统计符号写出模型(所有模型，包括先验分布)，写出(未归一化)关节后验密度。如上所述，对数据使用普通模型。

   (b)将超参数$Eq.$(21.1)的非归一化边缘后验密度的对数编程为$R$函数。

   (c)合适的模型。你可以使用$MCMC$，正态逼近，变分贝叶斯，期望传播，$Stan$，或任何其他方法。但你的匹配必须是贝叶斯的。

   (d)将你的估计和数据一起绘制成图表(在一个页面上绘制多个图表)。

3. 二元数据的高斯过程:重复前面的练习，但这次使用二项模型对是/否响应。计算会更复杂，但结果应该是相似的。讨论与前一个练习的结果相比的任何差异。

4. 带有多个预测因子的高斯过程:重复前面的练习，但这次是估算人口中认为自己认识某个同性恋的人的百分比(2004年)，这是三个预测因子的函数:年龄、性别和种族。

5. 二进制数据的高斯过程:486页的表19.1给出了职业高尔夫球手推杆成功率的数据。

   (a)拟合高斯过程模型的成功概率(使用二项可能性)作为距离的函数。对比练习19.2和20.4的答案。

   (b)使用后验预测检验来评估模型的拟合性。

6. 用高斯过程建立模型:

   (a)复制21.2节中的生日分析。通过逐个添加协方差函数来建立模型。

   (b)每周的天数和季节性影响似乎随着时间的推移而增加。扩展模型，以允许日对年的影响以类似的方式随时间增加。将扩展模型拟合到数据和图表中，并讨论结果。

7. 层次模型和高斯过程:重复练习20.5使用高斯过程而不是样条模型的底层时间序列。

8. 当$h=1,...,k$时，有$\mu(x)=\sum_{h=1}^k\beta_hb_h(x)$和$b_h(x)=exp(\psi(x-\tau_h)^2)$。

   (a)如果可能，选择一个先验$(\beta_1,…,\beta_k)$让，$\mu\sim GP(m, k)$是一个具有均值函数$m$和协方差函数$k$的高斯过程。

   (b)描述$m$和$k$的精确解析形式(如果可能的话)。

   (c)协方差函数和让$k(x, x') = exp(-k(x-x')^2)$有什么不同?

   (d)描述一种使$ψ$和$\tau_1,...,\tau_k$最小化的算法，以尽量减少这种差异。

9. 继续前面的问题，假设我们让$\mu(x) = \beta_1+\beta_2x$，在$\beta_1$和$\beta_2$上有高斯先验。

   (a)这是否诱发了一个先验于函数$\mu(x)$的高斯过程?

   (b)既然我们有一个高斯过程先验，这是否意味着我们可以用这个先验捕获非线性函数?















[^1]: 在一些文献中，参数化是以$α=1/l^2$​​表示的。

