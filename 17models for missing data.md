**缺失数据模型**
===========

涉及缺失数据的问题分析通常可以分为两个主要任务：（1）**多重推断**——即模拟从基于观测值$y_{obs}$的未观测数据$y_{mis}$的条件后验预测分布中抽样（2）以及**从模型参数$\theta$的后验分布中推断**。

**总的思想**是扩展模型规范，以纳入缺失的观察结果，然后通过对缺失值的分布进行平均来执行推断。

贝叶斯推断**没有区分缺失的数据和参数**：两者都是不确定的，而且它们都有一个联合的后验分布，条件是观测数据。

当为观测数据、未观测数据和参数建立联合模型时，就出现了实际的区别。我们倾向于将其分为三部分：
1. 参数的先验分布（如果模型是分层的，则是超先验分布）
2. 所有数据的联合模型(缺失和观察到的）
3. 以及缺失过程的包含模型。

>如果缺失的数据机制是可忽略的，那么对参数和缺失数据的推断可以继续进行，而不建模包含过程。但是，在模拟复制的数据集以进行模型检查时，一般需要对此过程进行建模。

## **1.符号**

令$y$表示在没有缺失值的情况下将观察到的“完整数据”，$y$可以是单变量度量的向量，也可以是每一行包含多变量的矩阵。此外，可以方便地将完整的数据$y$看作是合并协变量。我们写$y=(y_{obs},y_{mis})$，其中$y_{obs}$表示观测值，$y_{mis}$表示缺失的值。

设定一随机变量$I$，表明$y$的每个成分是被观察到还是缺失。$I$是与$y$大小相同的数据结构，如果观察到$y$的相应分量，$I$的每个元素等于1，如果缺失，则等于0；假设$I$是完全观察到的。在样本调查中，若单元$i$对应项目$j$无响应，则$I_{ij}=0$。

给定参数$(\theta、\phi)$的$(y、I)$的联合分布可以写为：

$$p(y,I|\theta,\phi)=p(y|\theta)p(I|y,\phi)$$

给定完整的数据集$y$的变量$I$的条件分布，由未知数$\phi$索引，描述了数据的缺失机制。观测信息为$(y_{obs}、I)$；观测数据的分布是通过对$y_{mis}$分布的积分得到的：

$$p(y_{obs},I|\theta,\phi)=\int p(y_{obs},y_{mis}|\theta)p(I|y_{obs},y_{mis},\phi)dy_{mis}\ \ \ \ (18.1)$$  

如果缺失的数据机制的分布不依赖于缺失的值，则认为缺失的数据是**随机缺失**的(MAR)，即

$$p(I|y_{obs},y_{mis},\phi)=p(I|y_{obs},\phi)$$

在MAR下，观测信息的联合分布（18.1），可以写成

$$
\begin{aligned}
p(y_{obs},I|\theta,\phi)&=p(I|y_{obs},\phi)\int p(y_{obs},y_{mis}|\theta)dy_{mis}\\&=p(I|y_{obs},\phi)p(y_{obs}|\theta)
\end{aligned}
$$

如果缺失数据机制的分布完全独立于$y$,即

$$p(I|y_{obs},y_{mis},\phi)=p(I|\phi)$$

在这种情况下，我们说缺失的数据**完全随机丢失**(MCAR)。
>前一段表明，较弱的MAR假设和不同的参数对于获得贝叶斯推断是有利的，而不需要进一步建模缺失数据机制。由于在实际问题中，MCAR是相对罕见的，我们在本章中重点讨论适用于更一般的MAR情况的方法。

## **2.多重推断**

>在缺失数据分析中，如果推断模型是合理的，对推断后的数据集的分析结果更有可能比丢弃缺失值的数据集提供更准确的估计。

多重推断的关键思想是**为数据集中缺失的值创建不止一组替换集**。这解决了单一推断的一个困难，即可以正确地反映在特定缺失数据模型下的无响应所导致的不确定性。本章用于获得后验推断的数据增强算法可以看作是迭代的多重推断。

在实践中，特别是当大多数数据值没有缺失时，通常将数据分析分为两部分：首先，清理数据和多次输入缺失的值，其次，使用输入的数据集对感兴趣的变量进行推断。在多重推断中，对$X_{mis}$和$\theta$的推断被分离出来：

1. 首先对$X$、$y$一起建模，获得了模型缺失数据和参数的联合推断。在这一点上，采取了令人惊讶的步骤，丢弃关于参数的推断，只保留完整的数据集$X^s =(X_{obs},X_{mis}^s)$进行一些随机模拟抽取$s$。

2. 对于每个输入的$X^s$，基于模型$p(y|X^s,\theta)$执行所需的$θ$推断，把输入的数据当作已知的数据来对待。

3. 结合来自不同推断的推断。通过贝叶斯模拟，这是简单的——只是将来自单独推论的模拟混合在一起。

### -*利用EM算法推断和数据增强*
-----------------------------

Gibbs抽样和EM算法，是复杂问题中用于模拟和获得后验模式的方法。Gibbs抽样和EM算法开创了一种相当旧的处理缺失数据的方法：**用估计值替换缺失的数据，估计模型参数**，也许，**重复这两个步骤几次**。通常，如果数据集被一些未观察到的值增强，可以更容易地分析，这些值可能被认为是缺失的数据。

### -*用多重推断对参数的推断*
----------------------------

具体地说，如果在单个模型下有$K$个估计集，设$\hat{\theta}_k$和$\hat{W}_k$，$k=1,...,K$，是K个完整数据**参数估计**和标量参数$\theta$的相关**方差估计**。$K$个完整数据的分析可以结合起来形成$\theta$的联合估计

$$\overline\theta _K=\frac1{K}\sum\limits_{k=1}^{K}\hat{\theta}_k$$

与此估计相关的方差有两个组成部分：**连续数据方差的平均值**（内部的计算成分），

$$\overline W _K=\frac1{K}\sum\limits_{k=1}^{K}\hat{W}_k$$

以及**估计量之间的方差**

$$B_K=\frac1{K-1}\sum\limits_{k=1}^K(\hat{\theta}_k-\overline{\theta}_K)^2$$

与$\overline{\theta}_K$相关的**总方差**为

$$T_K=\overline{W}_K+\frac{K+1}{K}B_K$$

为$\theta$创建区间估计的标准近似公式使用了**t分布**，自由度为：

$$d.f.=(K-1)\lgroup1+\frac{1}{K+1}\frac{\overline W_K}{B_K}\rgroup^2$$

## **3.多元正态模型中数据缺失**

我们考虑基本的连续数据模型，其中$y$代表一个来自$d$维多元正态分布$N_d(\mu,\Sigma)$样本量为$n$的样本，$y_{obs}$为观测值的集合，$y_{mis}$为缺失值的集合。我们在这里令**先验分布**为**均匀分布**形式。

### -*利用$EM$算法寻找后验模式*
----------------------------

多元正态分布是一典型指数分布族的成员，有着充分统计量：

$$\sum\limits_{i=1}^n y_{ij},\quad j=1,...,d,$$

和

$$\sum\limits_{i=1}^n y_{ij}y_{ik},\quad j,k=1,...,d,$$

设$y_{obs\ i}$表示观察到的$y_i=(y_{i1},...,y_{id})$的分量，$y_{mis\ i}$表示缺失的分量。设$\theta^{old}=(\mu^{old},\Sigma^{old})$表示模型参数的当前估计值。

$EM$算法的$E$步根据观测值和当前参数值估计值计算**这些充分统计量的期望值**。具体来说：

$$E\lgroup\sum\limits_{i=1}^ny_{ij}|y_{obs},\theta^{old}\rgroup=\sum\limits_{i=1}^ny_{ij}^{old}$$

$$E(\sum\limits_{i=1}^{n}y_{ij}y_{ik}|y_{obs},\theta^{old})=\sum\limits_{i=1}^{n}(y_{ij}^{old}y_{ik}^{old}+c_{ijk}^{old}),$$

其中：

$$
y_{ij}^{old}= 
\begin{cases}
y_{ij}& \text{如果是观测值}\\
E(y_{ij}|y_{obs},\theta^{old})& \text{其它.}
\end{cases}
$$

并且

$$
c_{ijk}^{old}= 
\begin{cases}
0& \text{如果是观测值}\\
cov(y_{ij},y_{ik}|y_{obs},\theta^{old})& \text{其它.}
\end{cases}
$$


条件期望和协方差易于计算：给定$y_{obs}$和$\theta$的$y_i$缺失元素$y_{mis\ i}$的条件后验分布为多元正态，均值向量和方差矩阵由完整的均值向量和方差矩阵$\theta^{old}$得到。

EM算法的$M$步**使用完整数据的充分统计量来计算下一个迭代**，$\theta^{new}=(\mu^{new}，\Sigma^{new})$，具体为：

$$\mu_j^{new} =\frac1{n}\sum\limits_{i=1}^n y_{ij}^{old},\ for \ j=1,...,d,$$

和：

$$\sigma_{jk}^{new} =\frac1{n}\sum\limits_{i=1}^n(y_{ij}^{old}y_{ik}^{old}+c_{ijk}^{old})-\mu_j^{new}\mu_k^{new},\ for \ j,k=1,...,d.$$

>EM算法的起始值可以用粗糙的方法得到。与往常一样，在确定后验模式时，在多个模式下使用多个起始值是明智的。另外方差矩阵的初始值必须是正定的。

### -*从模型参数的后验分布中抽取样本*
-----------------------------------

我们可以*从正态分布中抽取缺失数据的估计值*，作为利用基于缺失值和参数的联合后验分布Gibbs抽样的数据增强的**初始值**并交替从它们的条件后验分布抽取$y_{mis}$,$\mu$和$\Sigma$。
>对于更复杂的模型，Gibbs抽样的一些步骤通常被Metropolis步骤所取代。

与EM算法一样，如果缺失的数据具有**单调模式**，抽取的效率可能有相当大的提高。

>事实上，对于单调缺失数据，在适当的参数化下，可以直接从不完全数据后验分布$p(\theta|y_{obs})$中提取。

假设$y_1$比$y_2$更易观测，$y_2$比$y_3$更易观测，以此类推。具体来说，让$\phi=\phi(\Theta)=(\phi_1,...,\phi_k)$，其中$\phi_1$表示单调模式中第一个变量块$y_1$的边际分布参数，$\phi_2$表示给定$y_1$的$y_2$的条件分布参数，以此类推(正态分布为$d$维，但单调模式一般定义$k≤d$个变量块)。

对于多元正态数据，$\phi_j$包含$y_j$对$y_1,...,y_{j−1}$的线性回归参数-回归系数和残差方差矩阵。参数$\Phi$是参数$\Theta$的一对一函数，$\Phi$的完整参数空间是$\phi_1,...,\phi_k$的参数空间的乘积。将似然因子分为$k$个不同的部分：

$$log\ p(y_{obs}|\phi)=\ log\ p(y_{obs1}|\phi_1)+log\ p(y_{obs2}|y_{obs1},\phi_2)+...+log\ p(y_{obsk}|y_{obs1},y_{obs2},...,y_{obsk-1},\phi_k)$$

第$j$部分只取决于参数$\phi_j$。如果先验分布的$p(\phi)$可以以封闭形式分解

$$p(\phi)=p(\phi_1)p(\phi_2|\phi_1) \ldots p(\phi_k|\phi_1,\ldots,\phi_{k-1})$$

然后就可以**直接从后验分布中**抽取：在 $y_{obs}$的条件下抽取$\phi_1$，在$\phi_1$和 $y_{obs}$条件下抽取$\phi_2$，以此类推。

对于不是精确单调的缺失数据模式，我们可以定义一个单调数据增强算法，它只需要输入足够的数据就能获得单调模式。

计算步骤从需要创建单调模式的$y_{mis}$中元素的条件分布中抽取一个样本。然后利用单调模式直接从后验分布中提取后验步骤。

通常，如果与单调性的背离不大，单调数据增强算法将比普通数据增强更有效。
>其中有几种方法来排序变量，都会导致几乎单调的模式。确定最佳的选择是复杂的，因为“最佳”是通过提供迭代模拟方法的最快收敛性来定义的。一种简单的方法是选择$y_1$为缺失值最少的变量，$y_2$是第二缺失值最少的变量，以此类推。

## **4.例子：对一系列民意调查的多重推断**

本节介绍一个扩展示例，说明了调查数据问题的贝叶斯分析所涉及的许多实际问题。这个例子涉及一系列有相对大量缺失数据的民意调查。

### -*背景*
-----------

1988年的美国总统选举很不同寻常，民主党候选人迈克尔·杜卡基斯在选举前四个月的民调中遥遥领先，但他最终输给了远远领先于他的共和党候选人乔治·布什。

我们利用**9个主要投票机构**在选举前六个月进行的**51项全国民调**的数据，研究了竞选期间的公众意见。我们的目标之一是**研究不同的人口群体投票意图的时间趋势**（例如：男性和女性；自称是民主党、共和党和独立人士；低收入和高收入等等)。

分析这51项调查需要在处理缺失数据时有所小心，因为并非所有调查都问及了所有感兴趣的问题。
>例如，被调查者自我的意识形态（自由主义者、中立主义者或保守主义者）是一个关键变量，但在51个调查中有10个缺失，包括我们在民主党提名大会期间唯一可用的调查。在不到一半的调查中，被调查者对国民经济的观点以及布什和杜卡基斯的看法的问题被调查，这使得他们较难被研究。估算对这些问题的回答将简化我们的分析，允许我们以相同的方式分析所有问题。

我们的方法是**对于每一项调查拟合一个单独的估计模型**，同时**将不同的调查模型中的参数与一个层次模型相关联**。这样就可以使某一缺失数据较大程度上由该调查数据决定，而调查中没有问到的问题推断将由其他调查项目的数据以及该调查中可用的其他的问题回答。

### -*多元数据缺失框架*
----------------------

我们建立S=51调查中提出的**Q=15**问题的层次多元模型进行计算，并不是所有调查中都包括的所有问题。这15个问题有感兴趣的结果变量（总统投票偏好），被认为与投票偏好关系最强的变量，以及几个被完全观察到或接近观察的人口统计学变量。我们还在分析中包括了每次调查进行的日期。

为了处理这两种缺失—“未被询问”和“未被回答”—我们增加了数据，使完整的数据是由所有$S$调查中同样的$Q$问题组成。我们用$\mathbf y_{si}=(\mathbf y_{si\ 1},...,\mathbf y_{si\ Q})$表示调查$s$中个体$i$对所有$Q$问题的回答。其中$\mathbf y_{si}$的一些元素可能缺失了。设$N_s$为调查中的受访者数量，完整数据有如下形式

$$((\mathbf y_{si\ 1},...,\mathbf y_{si\ Q}):i=1,...,N_s,s=1,...,S)$$

我们假定数据缺失是**MAR（随机缺失）形式**。

### -*多项调查的层次模型*
------------------------

利用多重调查的数据结构来估算（18.5）中缺失值的最简单的模型是一个分层模型。

**我们假设在个体水平上有一个多元正态分布，调查的均值向量为$\mu_s$，并且假设所有调查的变量方差矩阵相同。**

假设我们在调查水平上有关于目标变量的$P$个协变量的数据。设$x_s=(x_{s1},...,x_{sP})$是每项调查的这些协变量的向量。我们假设每个$S$调查都能完全观察到$x_s$。我们使用符号$\mathbf X$表示完全观测协变量的$S\times P$大小的矩阵(行$s$包含调查$s$的协变量)。然后我们的调查均值模型是多元回归：

$$\mu_s|\mathbf X,\beta,\Sigma \sim N_Q(\beta x_s,\Sigma),\  \ \ \ s=1,...,S,$$

其中，$\beta$为一$Q \times P$矩阵，表示均值向量关于调查协变量向量回归方程的回归系数；是 一个对角矩阵，为Diag（σ，……，σ）。由于 是对角的，方程（18.7）可以表示为Q个具有正态误差的线性回归模型：

$$Diag(\sigma_1^2 ,...,\sigma_Q^2)$$

其中$\mu_{sj}$是$\mu_s$的第$j$个成分，$\beta_j$是$\beta$的第$j$行。方程（18.6)和(18.7）中的模型允许汇集$S$个调查的所有信息，并推断所有缺失的值，包括那些由于调查中没有提出问题的缺失值。

为了数学上的方便，我们使用以下非信息先验分布作为$(\phi,\beta,\Sigma)$的先验分布

$$p(\phi,\beta,\Sigma)=p(\phi)p(\beta)\prod_{q=1}^Q p(\sigma_Q^2) \propto|\phi|^{-(Q+1/2)}$$

如果对所有问题的回答都少于$Q$个人，那么有必要对参数使用适当的先验分布。

### -*离散变量的连续模型使用*
---------------------------

当使用基于正态分布的连续计算模型时，有一个自然的问题，就是离散变量有不同的离散类型。

在我们的分析中，一些变量（性别、种族)被编码为无序和离散的，其他变量(投票意图、教育)是有序和离散的，而其他变量(年龄、收入）可能是连续的，但被编码为有序和离散的。

我们酌情记录来自不同调查组织的回答，以便每个问题的回答在一个共同的范围内。

有几种方法可以利用连续模型来推断离散变量。我们采用的方法是**将数据作为连续值进行建模**，并**估计缺失数据的“连续值”**。
>在我们的例子中，这种简化几乎没有损失，因为最“离散”的变量（性别、种族、投票意图)被完全观察到或几乎观察到，而最没有回应的变量(意见问题）本质上是连续的。

当需要离散值时，我们将**连续估计四舍五入**。

### -*计算*
-----------

>该模型足够复杂，数据集也足够大，需要编写一个特殊的程序来模拟后验。一个简单的Gibbs或Metropolis算法会运行得太慢，无法在这里工作。

我们的方法使用了两个基本步骤：增强数据形成单调的缺失数据模式（如第3节所述），以及Gibbs抽样在单调模式下从缺失数据和参数的联合后验分布中提取模拟。

单调数据增强对于多次调查的多重推断是有效的，因为数据可以被排序，由于在一些调查中有些问题没有被问及，因此大部分缺失值属于单调模式。图18.1显示了选举前调查所构建的单调数据模式，变量按缺失数据比例的递减顺序排列。最容易观察到的变量是性别，最少被观察到的是候选人的感知意识形态。

<img src="https://github.com/beibeichen01/2021BayesianCourse/blob/main/figure/cbb.1.png?raw=true" align="center">


设$k$对$Q$可能的观察数据模式进行索引，$n_k$为具有该模式的受访者数量，以及 $s_i$包含第$k$个观察数据模式中第$i$个受访者的调查。所得到的数据矩阵可以写为

$$y_{mp}=((y_{s_i\ i1}^k,...,y_{s_i\ ik}^k),i=1,...,n_k,k=1,...,Q),$$

令 $y_{mp,mis}$表示所有未被观测到的数据，$y_{obs}$表示观测到数据的集合，因此，$y_{mp}=(y_{obs},y_{mp,mis})$

综上所述，我们有观测数据$y_{obs}$，和未知量$(y_{mp,mis},\phi,\mu_1,...,\mu_S,\beta,\Sigma)$。为了从给定观测数据$y_{obs}$的$(y_{mp,mis},\phi,\mu_1,...,\mu_S,\beta,\Sigma)$后验分布中抽取样本，我们采用以如下步骤迭代的Gibbs抽样：

1. 给定$\phi,\mu_1,...,\mu_S,\beta,\Sigma,y_{obs}$推断$y_{mp,mis}$。在正态模型下，这些推断需要从联合正态分布中得到一系列的数据来进行调查响应

2. 给定$\mu_1,...,\mu_S,y_{obs},y_{mp,mis}$估计$(\phi,\beta,\Sigma)$。这些都是单调模式下“完整”数据的层次线性模型中的参数。

3. 给定$\phi,\beta,\Sigma,y_{obs},y_{mp,mis}$估计,$(\mu_1,...,\mu_S)$。参数$\mu_1,...,\mu_S$相互独立，并在这个条件后验分布中呈正态分布

### -*解释问卷设计和权重*
-----------------------

我们在进行推断时没有使用问卷权数，因为权重所基于的变量，总的意义上，已经包含在模型中了。因此，权重没有提供关于缺失数据推断的额外信息。

然而，我们在计算基于估算数据的均值时使用调查权重，以获得人口统计变量无条件的人口均值的无偏估计。

### -*结果*
-----------

我们用每个变量的单独图表来检查51项调查的推断结果；我们在图18.2中说明了其中两个变量：“收入”（选择它是因为在研究的四个月期间应该保持稳定）和“Dukakis的感知意识形态”（我们预计在活动中会发生改变）。

图18.2中估计和标准误差条是对两个问题的人群平均回答：(a)收入（以数千美元为单位）和(b)Dukakis的感知意识形态（1-7范围表示从自由主义到保守主义）。每个符号代表一个调查，每个字母表示调查机构。字母的大小表示对问题的回答数量，字母较大表示回答几乎完整，小的字母表示回答的很少。圆圈字母表示没有提出问题的调查；对这些调查的估计有更大的标准误差。

<img src="https://github.com/beibeichen01/2021BayesianCourse/blob/main/figure/cbb.2.png?raw=true" align="center">

图18.2a中竖条表示平均收入后验均值的±1标准误差，其中标准误差包括推断内抽样方差和推断间方差。其中竖条上的内部括号仅表示推断内抽样方差。

从图中可以看出，即使是那些被询问（并被大多数受访者回答）的调查，由于调查的样本量很少，估计的人口平均收入也有非零标准误差。对于被问到收入问题的调查，推断内的方差几乎等于总的方差，这是有意义的，因为当被问到一个问题时，大多数受访者回答了。多重推断程序对那些缺少收入问题的调查的收入推断做出了较弱的陈述（即有很大的标准错误）。这是有意义的，因为收入与其他问题并不高度相关。

<img src="https://github.com/beibeichen01/2021BayesianCourse/blob/main/figure/cbb.3.png?raw=true" align="center">

图18.2b显示了Dukakis感知到的意识形态的类似情节。观察到的和估算出的调查结果都显示了这个变量的时间趋势——Dukakis在竞选快结束时被认为更加自由。在该模型的早期版本（这里没有显示）中，没有包括时间作为预测器，Dukakis的感知意识形态的情节显示了一个问题：观察到的数据显示了时间趋势，但推断数据没有。这个图有助于揭示模型的缺陷：估算的调查结果看起来与数据系统地不同。

## **5.参考文献**

[1]Kong, A., Wong, w. H.,and Liu, J. S. (1996). Sequential imputations and Bayesian missing data
problems. Journal of the American Statistical Association 89, 278–288.

[2]Little, R. J. A., and Rubin, D. B. (2002). Statistical Analysis with Missing Data, second edition.New York: Wiley.

[3]Liu, C. (1995). Missing data imputation using the multivariate t distribution. Journal of Multivariate Analysis 48, 198–206.

[4]Little, R. J. A., and Rubin, D. B. (2002). Statistical Analysis with Missing Data, second edition.
New York: Wiley.

[5]Liu, C. (1995). Missing data imputation using the multivariate t distribution. Journal of Multivariate Analysis 48, 198–206.

[6]Rubin, D. B. (1976). Inference and missing data. Biometrika 63, 581–592.

[7]Van Buuren, S. (2012). Flexible Imputation of Missing Data. London: Chapman & Hall.

 
